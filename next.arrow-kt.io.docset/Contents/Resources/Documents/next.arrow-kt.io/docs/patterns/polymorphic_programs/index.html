<!DOCTYPE html><html><head>
    <meta charset="UTF-8"/>
    <title>Arrow</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <meta name="description" content="Functional companion to Kotlin&#39;s Standard Library"/>
    <meta name="keywords" content="functional-programming, kotlin-library, monads, monad-transformers, functional-data-structure, kotlin, fp-types, adt, free-monads, tagless-final, mtl, for-comprehension, category-theory"/>

    <meta property="og:image" content="http://arrow-kt.io/img/poster.png"/>
    <meta property="og:title" content="Arrow"/>
    <meta property="og:site_name" content="Arrow"/>
    <meta property="og:url" content="http://arrow-kt.io/"/>
    <meta property="og:type" content="website"/>
    <meta property="og:description" content="Functional companion to Kotlin&#39;s Standard Library"/>
    <meta property="og:keywords" content="functional-programming, kotlin-library, monads, monad-transformers, functional-data-structure, kotlin, fp-types, adt, free-monads, tagless-final, mtl, for-comprehension, category-theory"/>

    <meta name="twitter:text:description" content="Functional companion to Kotlin&#39;s Standard Library"/>
    <meta name="twitter:card" content="summary_large_image"/>
    <meta name="twitter:site" content="@arrow_kt"/>
    <meta name="twitter:creator" content="@arrow_kt"/>
    <meta name="twitter:image" content="http://arrow-kt.io/img/twitter-card.png"/>

    <!-- Arrow versions metadata -->
    <meta name="previous-version" data-title="" data-url=""/>
    <meta name="stable-version" data-title="" data-url=""/>
    <meta name="next-version" data-title="" data-url=""/>

    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.css" rel="stylesheet" type="text/css"/>
    <!-- Animated -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.5.2/animate.min.css"/>
    <!-- Arrow main css -->
    <link rel="shortcut icon" href="../../../img/favicon.png"/>
    <!-- highlight  css -->
    <link rel="stylesheet" type="text/css" href="../../../css/highlight/atom-one-light.css"/>
    <!-- Arrow main css -->
    <link rel="stylesheet" type="text/css" href="../../../css/arrow.css"/>

    <!-- Code to manage version information -->
    <script src="../../../js/docVersions.js" defer=""></script>

    <!-- Diagrams support -->
    <script src="../../../js/dagre.min.js"></script>
    <script src="../../../js/lodash.min.js"></script>
    <script src="../../../js/nomnoml.js"></script>
    <script src="../../../js/diagrams.js" async=""></script>

    
        <!-- Global site tag (gtag.js) - Google Analytics -->
<script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-18433785-18"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'UA-18433785-18');
</script>

    
</head>

<body id="doc-body">
<div id="wrapper">
    <div id="sidebar-wrapper">
    <div class="sidebar-brand">
        <a class="brand" href="https://next.arrow-kt.io/">
            <img src="../../../img/arrow-brand-sidebar.svg" alt=""/>
            <span>&Lambda;rrow</span>
        </a>
        <button type="button" id="main-toggle" class="sidebar-toggle">
            <span class="close"></span>
        </button>
    </div>

    <ul class="sidebar-nav sidebar-doc-versions">
  <li class="sidebar-nav-item">
    <a href="index.html#">
      <span>Arrow version</span>
      <span id="arrow-version"></span>
    </a>
    <ul>
      <li>
        <a href="https://arrow-kt.io/docs/">
          <span>
            v0.9.0 - STABLE
          </span>
        </a>
      </li>

      <li>
        <a href="../../index.html">
            <span>
              v0.9.1 - NEXT
            </span>
        </a>
      </li>

      <li>
        <a href="https://0-8-2.arrow-kt.io/docs/">
            <span>
              v0.8.2 -
              PREVIOUS
            </span>
        </a>
      </li>

      
        
      
        
      
        
      
    </ul>
  </li>
</ul>


    <ul class="sidebar-nav">
        
        <li class="sidebar-nav-item">
            <a href="index.html#">
                <span>Quick Start</span>
                
                <i class="fa fa-angle-right"></i>
                
            </a>
            
            <ul>
                
                <li>
                    <a href="../../index.html">
                        <i class="fa fa-circle"></i>
                        <span>Index</span>
                    </a>
                </li>
                
                <li>
                    <a href="../../quickstart/libraries/index.html">
                        <i class="fa fa-circle"></i>
                        <span>Libraries</span>
                    </a>
                </li>
                
                <li>
                    <a href="https://next.arrow-kt.io/blog/">
                        <i class="fa fa-circle"></i>
                        <span>Blogs &amp; Presentations</span>
                    </a>
                </li>
                
                <li>
                    <a href="../../quickstart/projects/index.html">
                        <i class="fa fa-circle"></i>
                        <span>Projects &amp; Examples</span>
                    </a>
                </li>
                
            </ul>
            
        </li>
        
        <li class="sidebar-nav-item">
            <a href="index.html#">
                <span>Arrow Fx</span>
                
                <i class="fa fa-angle-right"></i>
                
            </a>
            
            <ul>
                
                <li>
                    <a href="../../effects/fx/index.html">
                        <i class="fa fa-circle"></i>
                        <span>Getting Started</span>
                    </a>
                </li>
                
                <li>
                    <a href="../../effects/fx/async/index.html">
                        <i class="fa fa-circle"></i>
                        <span>Asynchronous &amp; Concurrent Programming</span>
                    </a>
                </li>
                
                <li>
                    <a href="../../effects/fx/polymorphism/index.html">
                        <i class="fa fa-circle"></i>
                        <span>Polymorphism. One Program multiple runtimes</span>
                    </a>
                </li>
                
            </ul>
            
        </li>
        
        <li class="sidebar-nav-item">
            <a href="index.html#">
                <span>API Docs</span>
                
                <i class="fa fa-angle-right"></i>
                
            </a>
            
            <ul>
                
                <li>
                    <a href="../../apidocs/arrow-typeclasses/index.html">
                        <i class="fa fa-circle"></i>
                        <span>Type Classes</span>
                    </a>
                </li>
                
                <li>
                    <a href="../../apidocs/arrow-core-data/index.html">
                        <i class="fa fa-circle"></i>
                        <span>Core Data Types</span>
                    </a>
                </li>
                
                <li>
                    <a href="../../apidocs/arrow-core-extensions/index.html">
                        <i class="fa fa-circle"></i>
                        <span>Core Extensions</span>
                    </a>
                </li>
                
                <li>
                    <a href="../../apidocs/arrow-extras/index.html">
                        <i class="fa fa-circle"></i>
                        <span>Core Extra Data Types</span>
                    </a>
                </li>
                
                <li>
                    <a href="../../apidocs/arrow-extras-extensions/index.html">
                        <i class="fa fa-circle"></i>
                        <span>Core Extra Extensions</span>
                    </a>
                </li>
                
                <li>
                    <a href="../../apidocs/arrow-effects-data/index.html">
                        <i class="fa fa-circle"></i>
                        <span>Effects</span>
                    </a>
                </li>
                
                <li>
                    <a href="../../apidocs/arrow-effects-extensions/index.html">
                        <i class="fa fa-circle"></i>
                        <span>Effects Extensions</span>
                    </a>
                </li>
                
                <li>
                    <a href="../../apidocs/arrow-effects-kotlinx-coroutines-data/index.html">
                        <i class="fa fa-circle"></i>
                        <span>Effects Coroutines</span>
                    </a>
                </li>
                
                <li>
                    <a href="../../apidocs/arrow-effects-kotlinx-coroutines-extensions/index.html">
                        <i class="fa fa-circle"></i>
                        <span>Effects Coroutines Extensions</span>
                    </a>
                </li>
                
                <li>
                    <a href="../../apidocs/arrow-effects-rx2-data/index.html">
                        <i class="fa fa-circle"></i>
                        <span>Effects Rx2</span>
                    </a>
                </li>
                
                <li>
                    <a href="../../apidocs/arrow-effects-rx2-extensions/index.html">
                        <i class="fa fa-circle"></i>
                        <span>Effects Rx2 Extensions</span>
                    </a>
                </li>
                
                <li>
                    <a href="../../apidocs/arrow-effects-reactor-data/index.html">
                        <i class="fa fa-circle"></i>
                        <span>Effects Reactor</span>
                    </a>
                </li>
                
                <li>
                    <a href="../../apidocs/arrow-effects-reactor-extensions/index.html">
                        <i class="fa fa-circle"></i>
                        <span>Effects Reactor Extensions</span>
                    </a>
                </li>
                
                <li>
                    <a href="../../apidocs/arrow-streams/index.html">
                        <i class="fa fa-circle"></i>
                        <span>Streams</span>
                    </a>
                </li>
                
                <li>
                    <a href="../../apidocs/arrow-mtl/index.html">
                        <i class="fa fa-circle"></i>
                        <span>MTL</span>
                    </a>
                </li>
                
                <li>
                    <a href="../../apidocs/arrow-optics/index.html">
                        <i class="fa fa-circle"></i>
                        <span>Optics</span>
                    </a>
                </li>
                
                <li>
                    <a href="../../apidocs/arrow-recursion-data/index.html">
                        <i class="fa fa-circle"></i>
                        <span>Recursion</span>
                    </a>
                </li>
                
                <li>
                    <a href="../../apidocs/arrow-recursion-extensions/index.html">
                        <i class="fa fa-circle"></i>
                        <span>Recursion Extensions</span>
                    </a>
                </li>
                
                <li>
                    <a href="../../apidocs/arrow-generic/index.html">
                        <i class="fa fa-circle"></i>
                        <span>Generic</span>
                    </a>
                </li>
                
                <li>
                    <a href="../../apidocs/arrow-free-data/index.html">
                        <i class="fa fa-circle"></i>
                        <span>Free</span>
                    </a>
                </li>
                
                <li>
                    <a href="../../apidocs/arrow-validation/index.html">
                        <i class="fa fa-circle"></i>
                        <span>Validation</span>
                    </a>
                </li>
                
            </ul>
            
        </li>
        
        <li class="sidebar-nav-item">
            <a href="index.html#">
                <span>Patterns</span>
                
                <i class="fa fa-angle-right"></i>
                
            </a>
            
            <ul>
                
                <li>
                    <a href="../glossary/index.html">
                        <i class="fa fa-circle"></i>
                        <span>Glossary</span>
                    </a>
                </li>
                
                <li>
                    <a href="../error_handling/index.html">
                        <i class="fa fa-circle"></i>
                        <span>Error Handling</span>
                    </a>
                </li>
                
                <li>
                    <a href="../dependency_injection/index.html">
                        <i class="fa fa-circle"></i>
                        <span>Dependency Injection</span>
                    </a>
                </li>
                
                <li>
                    <a href="../monads/index.html">
                        <i class="fa fa-circle"></i>
                        <span>The Monad Tutorial</span>
                    </a>
                </li>
                
                <li>
                    <a href="../monad_comprehensions/index.html">
                        <i class="fa fa-circle"></i>
                        <span>Monad Comprehensions</span>
                    </a>
                </li>
                
                <li>
                    <a href="index.html">
                        <i class="fa fa-circle"></i>
                        <span>Polymorphic Programs</span>
                    </a>
                </li>
                
                <li>
                    <a href="../free_algebras/index.html">
                        <i class="fa fa-circle"></i>
                        <span>Free Algebras</span>
                    </a>
                </li>
                
            </ul>
            
        </li>
        
        <li class="sidebar-nav-item">
            <a href="index.html#">
                <span>Data Types</span>
                
                <i class="fa fa-angle-right"></i>
                
            </a>
            
            <ul>
                
                <li>
                    <a href="../../datatypes/intro/index.html">
                        <i class="fa fa-circle"></i>
                        <span>Intro</span>
                    </a>
                </li>
                
                <li>
                    <a href="../../datatypes/basic/index.html">
                        <i class="fa fa-circle"></i>
                        <span>Basic Types</span>
                    </a>
                </li>
                
                <li>
                    <a href="../../arrow/core/option/index.html">
                        <i class="fa fa-circle"></i>
                        <span>Option</span>
                    </a>
                </li>
                
                <li>
                    <a href="../../arrow/core/either/index.html">
                        <i class="fa fa-circle"></i>
                        <span>Either</span>
                    </a>
                </li>
                
                <li>
                    <a href="../../arrow/core/try/index.html">
                        <i class="fa fa-circle"></i>
                        <span>Try</span>
                    </a>
                </li>
                
                <li>
                    <a href="../../arrow/data/validated/index.html">
                        <i class="fa fa-circle"></i>
                        <span>Validated</span>
                    </a>
                </li>
                
                <li>
                    <a href="../../arrow/data/nonemptylist/index.html">
                        <i class="fa fa-circle"></i>
                        <span>NonEmptyList</span>
                    </a>
                </li>
                
                <li>
                    <a href="../../arrow/data/listk/index.html">
                        <i class="fa fa-circle"></i>
                        <span>ListK</span>
                    </a>
                </li>
                
                <li>
                    <a href="../../arrow/data/sequencek/index.html">
                        <i class="fa fa-circle"></i>
                        <span>SequenceK</span>
                    </a>
                </li>
                
                <li>
                    <a href="../../arrow/data/setk/index.html">
                        <i class="fa fa-circle"></i>
                        <span>SetK</span>
                    </a>
                </li>
                
                <li>
                    <a href="../../arrow/data/mapk/index.html">
                        <i class="fa fa-circle"></i>
                        <span>MapK</span>
                    </a>
                </li>
                
                <li>
                    <a href="../../arrow/data/sortedmapk/index.html">
                        <i class="fa fa-circle"></i>
                        <span>SortedMapK</span>
                    </a>
                </li>
                
                <li>
                    <a href="../../arrow/data/ior/index.html">
                        <i class="fa fa-circle"></i>
                        <span>Ior</span>
                    </a>
                </li>
                
                <li>
                    <a href="../../arrow/core/id/index.html">
                        <i class="fa fa-circle"></i>
                        <span>Id</span>
                    </a>
                </li>
                
                <li>
                    <a href="../../arrow/data/reader/index.html">
                        <i class="fa fa-circle"></i>
                        <span>Reader</span>
                    </a>
                </li>
                
                <li>
                    <a href="../../arrow/data/kleisli/index.html">
                        <i class="fa fa-circle"></i>
                        <span>Kleisli</span>
                    </a>
                </li>
                
                <li>
                    <a href="../../arrow/data/state/index.html">
                        <i class="fa fa-circle"></i>
                        <span>State</span>
                    </a>
                </li>
                
                <li>
                    <a href="../../arrow/data/statet/index.html">
                        <i class="fa fa-circle"></i>
                        <span>StateT</span>
                    </a>
                </li>
                
                <li>
                    <a href="../../arrow/data/store/index.html">
                        <i class="fa fa-circle"></i>
                        <span>Store</span>
                    </a>
                </li>
                
                <li>
                    <a href="../../arrow/data/moore/index.html">
                        <i class="fa fa-circle"></i>
                        <span>Moore</span>
                    </a>
                </li>
                
                <li>
                    <a href="../../arrow/data/sum/index.html">
                        <i class="fa fa-circle"></i>
                        <span>Sum</span>
                    </a>
                </li>
                
                <li>
                    <a href="../../arrow/data/day/index.html">
                        <i class="fa fa-circle"></i>
                        <span>Day</span>
                    </a>
                </li>
                
                <li>
                    <a href="../../arrow/data/writert/index.html">
                        <i class="fa fa-circle"></i>
                        <span>WriterT</span>
                    </a>
                </li>
                
                <li>
                    <a href="../../arrow/free/trampoline/index.html">
                        <i class="fa fa-circle"></i>
                        <span>Trampoline</span>
                    </a>
                </li>
                
                <li>
                    <a href="../../arrow/data/coproduct/index.html">
                        <i class="fa fa-circle"></i>
                        <span>Coproduct</span>
                    </a>
                </li>
                
                <li>
                    <a href="../../arrow/core/eval/index.html">
                        <i class="fa fa-circle"></i>
                        <span>Eval</span>
                    </a>
                </li>
                
                <li>
                    <a href="../../arrow/data/optiont/index.html">
                        <i class="fa fa-circle"></i>
                        <span>OptionT</span>
                    </a>
                </li>
                
                <li>
                    <a href="../../arrow/data/eithert/index.html">
                        <i class="fa fa-circle"></i>
                        <span>EitherT</span>
                    </a>
                </li>
                
                <li>
                    <a href="../../arrow/core/function0/index.html">
                        <i class="fa fa-circle"></i>
                        <span>Function0</span>
                    </a>
                </li>
                
                <li>
                    <a href="../../arrow/core/function1/index.html">
                        <i class="fa fa-circle"></i>
                        <span>Function1</span>
                    </a>
                </li>
                
                <li>
                    <a href="../../arrow/typeclasses/const/index.html">
                        <i class="fa fa-circle"></i>
                        <span>Const</span>
                    </a>
                </li>
                
            </ul>
            
        </li>
        
        <li class="sidebar-nav-item">
            <a href="index.html#">
                <span>Type Classes</span>
                
                <i class="fa fa-angle-right"></i>
                
            </a>
            
            <ul>
                
                <li>
                    <a href="../../typeclasses/intro/index.html">
                        <i class="fa fa-circle"></i>
                        <span>Intro</span>
                    </a>
                </li>
                
                <li>
                    <a href="../../arrow/typeclasses/show/index.html">
                        <i class="fa fa-circle"></i>
                        <span>Show</span>
                    </a>
                </li>
                
                <li>
                    <a href="../../arrow/typeclasses/eq/index.html">
                        <i class="fa fa-circle"></i>
                        <span>Eq</span>
                    </a>
                </li>
                
                <li>
                    <a href="../../arrow/typeclasses/hash/index.html">
                        <i class="fa fa-circle"></i>
                        <span>Hash</span>
                    </a>
                </li>
                
                <li>
                    <a href="../../arrow/typeclasses/order/index.html">
                        <i class="fa fa-circle"></i>
                        <span>Order</span>
                    </a>
                </li>
                
                <li>
                    <a href="../../arrow/typeclasses/semigroup/index.html">
                        <i class="fa fa-circle"></i>
                        <span>Semigroup</span>
                    </a>
                </li>
                
                <li>
                    <a href="../../apidocs/arrow-typeclasses/arrow.typeclasses/-semigroupal/index.html">
                        <i class="fa fa-circle"></i>
                        <span>Semigroupal</span>
                    </a>
                </li>
                
                <li>
                    <a href="../../apidocs/arrow-typeclasses/arrow.typeclasses/-monoidal/index.html">
                        <i class="fa fa-circle"></i>
                        <span>Monoidal</span>
                    </a>
                </li>
                
                <li>
                    <a href="../../arrow/typeclasses/monoid/index.html">
                        <i class="fa fa-circle"></i>
                        <span>Monoid</span>
                    </a>
                </li>
                
                <li>
                    <a href="../../apidocs/arrow-typeclasses/arrow.typeclasses/-semiring/index.html">
                        <i class="fa fa-circle"></i>
                        <span>Semiring</span>
                    </a>
                </li>
                
                <li>
                    <a href="../../arrow/typeclasses/foldable/index.html">
                        <i class="fa fa-circle"></i>
                        <span>Foldable</span>
                    </a>
                </li>
                
                <li>
                    <a href="../../arrow/typeclasses/bifoldable/index.html">
                        <i class="fa fa-circle"></i>
                        <span>Bifoldable</span>
                    </a>
                </li>
                
                <li>
                    <a href="../../arrow/typeclasses/traverse/index.html">
                        <i class="fa fa-circle"></i>
                        <span>Traverse</span>
                    </a>
                </li>
                
                <li>
                    <a href="../../arrow/typeclasses/reducible/index.html">
                        <i class="fa fa-circle"></i>
                        <span>Reducible</span>
                    </a>
                </li>
                
                <li>
                    <a href="../../arrow/mtl/typeclasses/traversefilter/index.html">
                        <i class="fa fa-circle"></i>
                        <span>TraverseFilter</span>
                    </a>
                </li>
                
                <li>
                    <a href="../../arrow/typeclasses/functor/index.html">
                        <i class="fa fa-circle"></i>
                        <span>Functor</span>
                    </a>
                </li>
                
                <li>
                    <a href="../../arrow/mtl/typeclasses/functorfilter/index.html">
                        <i class="fa fa-circle"></i>
                        <span>FunctorFilter</span>
                    </a>
                </li>
                
                <li>
                    <a href="../../arrow/typeclasses/applicative/index.html">
                        <i class="fa fa-circle"></i>
                        <span>Applicative</span>
                    </a>
                </li>
                
                <li>
                    <a href="../../arrow/typeclasses/applicativeerror/index.html">
                        <i class="fa fa-circle"></i>
                        <span>ApplicativeError</span>
                    </a>
                </li>
                
                <li>
                    <a href="../../arrow/typeclasses/selective/index.html">
                        <i class="fa fa-circle"></i>
                        <span>Selective</span>
                    </a>
                </li>
                
                <li>
                    <a href="../../arrow/typeclasses/monad/index.html">
                        <i class="fa fa-circle"></i>
                        <span>Monad</span>
                    </a>
                </li>
                
                <li>
                    <a href="../../arrow/typeclasses/monaderror/index.html">
                        <i class="fa fa-circle"></i>
                        <span>MonadError</span>
                    </a>
                </li>
                
                <li>
                    <a href="../../arrow/effects/typeclasses/bracket/index.html">
                        <i class="fa fa-circle"></i>
                        <span>Bracket</span>
                    </a>
                </li>
                
                <li>
                    <a href="../../arrow/mtl/typeclasses/monadfilter/index.html">
                        <i class="fa fa-circle"></i>
                        <span>MonadFilter</span>
                    </a>
                </li>
                
                <li>
                    <a href="../../arrow/mtl/typeclasses/monadreader/index.html">
                        <i class="fa fa-circle"></i>
                        <span>MonadReader</span>
                    </a>
                </li>
                
                <li>
                    <a href="../../arrow/mtl/typeclasses/monadwriter/index.html">
                        <i class="fa fa-circle"></i>
                        <span>MonadWriter</span>
                    </a>
                </li>
                
                <li>
                    <a href="../../arrow/mtl/typeclasses/monadstate/index.html">
                        <i class="fa fa-circle"></i>
                        <span>MonadState</span>
                    </a>
                </li>
                
                <li>
                    <a href="../../arrow/mtl/typeclasses/monadcombine/index.html">
                        <i class="fa fa-circle"></i>
                        <span>MonadCombine</span>
                    </a>
                </li>
                
                <li>
                    <a href="../../arrow/typeclasses/comonad/index.html">
                        <i class="fa fa-circle"></i>
                        <span>Comonad</span>
                    </a>
                </li>
                
                <li>
                    <a href="../../arrow/typeclasses/bimonad/index.html">
                        <i class="fa fa-circle"></i>
                        <span>Bimonad</span>
                    </a>
                </li>
                
                <li>
                    <a href="../../arrow/typeclasses/bifunctor/index.html">
                        <i class="fa fa-circle"></i>
                        <span>Bifunctor</span>
                    </a>
                </li>
                
                <li>
                    <a href="../../arrow/typeclasses/profunctor/index.html">
                        <i class="fa fa-circle"></i>
                        <span>Profunctor</span>
                    </a>
                </li>
                
                <li>
                    <a href="../../arrow/typeclasses/semigroupk/index.html">
                        <i class="fa fa-circle"></i>
                        <span>SemigroupK</span>
                    </a>
                </li>
                
                <li>
                    <a href="../../arrow/typeclasses/monoidk/index.html">
                        <i class="fa fa-circle"></i>
                        <span>MonoidK</span>
                    </a>
                </li>
                
                <li>
                    <a href="https://next.arrow-kt.io/docs/typeclasses/inject/">
                        <i class="fa fa-circle"></i>
                        <span>Inject</span>
                    </a>
                </li>
                
                <li>
                    <a href="../../arrow/typeclasses/alternative/index.html">
                        <i class="fa fa-circle"></i>
                        <span>Alternative</span>
                    </a>
                </li>
                
                <li>
                    <a href="../../arrow/typeclasses/divide/index.html">
                        <i class="fa fa-circle"></i>
                        <span>Divide</span>
                    </a>
                </li>
                
                <li>
                    <a href="../../arrow/typeclasses/divisible/index.html">
                        <i class="fa fa-circle"></i>
                        <span>Divisible</span>
                    </a>
                </li>
                
                <li>
                    <a href="../../arrow/typeclasses/decidable/index.html">
                        <i class="fa fa-circle"></i>
                        <span>Decidable</span>
                    </a>
                </li>
                
            </ul>
            
        </li>
        
        <li class="sidebar-nav-item">
            <a href="index.html#">
                <span>Effects</span>
                
                <i class="fa fa-angle-right"></i>
                
            </a>
            
            <ul>
                
                <li>
                    <a href="../../effects/io/index.html">
                        <i class="fa fa-circle"></i>
                        <span>IO</span>
                    </a>
                </li>
                
                <li>
                    <a href="../../effects/monaddefer/index.html">
                        <i class="fa fa-circle"></i>
                        <span>MonadDefer</span>
                    </a>
                </li>
                
                <li>
                    <a href="../../effects/async/index.html">
                        <i class="fa fa-circle"></i>
                        <span>Async</span>
                    </a>
                </li>
                
                <li>
                    <a href="../../effects/effect/index.html">
                        <i class="fa fa-circle"></i>
                        <span>Effect</span>
                    </a>
                </li>
                
                <li>
                    <a href="../../effects/promise/index.html">
                        <i class="fa fa-circle"></i>
                        <span>Promise</span>
                    </a>
                </li>
                
                <li>
                    <a href="../../effects/ref/index.html">
                        <i class="fa fa-circle"></i>
                        <span>Ref</span>
                    </a>
                </li>
                
                <li>
                    <a href="../../effects/fiber/index.html">
                        <i class="fa fa-circle"></i>
                        <span>Fiber</span>
                    </a>
                </li>
                
                <li>
                    <a href="../../apidocs/arrow-effects-data/arrow.effects/-resource/index.html">
                        <i class="fa fa-circle"></i>
                        <span>Resource</span>
                    </a>
                </li>
                
            </ul>
            
        </li>
        
        <li class="sidebar-nav-item">
            <a href="index.html#">
                <span>Optics</span>
                
                <i class="fa fa-angle-right"></i>
                
            </a>
            
            <ul>
                
                <li>
                    <a href="../../optics/dsl/index.html">
                        <i class="fa fa-circle"></i>
                        <span>Optics DSL</span>
                    </a>
                </li>
                
                <li>
                    <a href="../../optics/iso/index.html">
                        <i class="fa fa-circle"></i>
                        <span>Iso</span>
                    </a>
                </li>
                
                <li>
                    <a href="../../optics/lens/index.html">
                        <i class="fa fa-circle"></i>
                        <span>Lens</span>
                    </a>
                </li>
                
                <li>
                    <a href="../../optics/optional/index.html">
                        <i class="fa fa-circle"></i>
                        <span>Optional</span>
                    </a>
                </li>
                
                <li>
                    <a href="../../optics/prism/index.html">
                        <i class="fa fa-circle"></i>
                        <span>Prism</span>
                    </a>
                </li>
                
                <li>
                    <a href="../../optics/getter/index.html">
                        <i class="fa fa-circle"></i>
                        <span>Getter</span>
                    </a>
                </li>
                
                <li>
                    <a href="../../optics/setter/index.html">
                        <i class="fa fa-circle"></i>
                        <span>Setter</span>
                    </a>
                </li>
                
                <li>
                    <a href="../../optics/fold/index.html">
                        <i class="fa fa-circle"></i>
                        <span>Fold</span>
                    </a>
                </li>
                
                <li>
                    <a href="../../optics/traversal/index.html">
                        <i class="fa fa-circle"></i>
                        <span>Traversal</span>
                    </a>
                </li>
                
                <li>
                    <a href="../../optics/cons/index.html">
                        <i class="fa fa-circle"></i>
                        <span>Cons</span>
                    </a>
                </li>
                
                <li>
                    <a href="../../optics/snoc/index.html">
                        <i class="fa fa-circle"></i>
                        <span>Snoc</span>
                    </a>
                </li>
                
                <li>
                    <a href="../../optics/at/index.html">
                        <i class="fa fa-circle"></i>
                        <span>At</span>
                    </a>
                </li>
                
                <li>
                    <a href="../../optics/index/index.html">
                        <i class="fa fa-circle"></i>
                        <span>Index</span>
                    </a>
                </li>
                
                <li>
                    <a href="../../optics/filterindex/index.html">
                        <i class="fa fa-circle"></i>
                        <span>FilterIndex</span>
                    </a>
                </li>
                
                <li>
                    <a href="../../optics/each/index.html">
                        <i class="fa fa-circle"></i>
                        <span>Each</span>
                    </a>
                </li>
                
            </ul>
            
        </li>
        
        <li class="sidebar-nav-item">
            <a href="index.html#">
                <span>&Lambda;rrow Query Language</span>
                
                <i class="fa fa-angle-right"></i>
                
            </a>
            
            <ul>
                
                <li>
                    <a href="../../aql/intro/index.html">
                        <i class="fa fa-circle"></i>
                        <span>&Lambda;rrow Query Language</span>
                    </a>
                </li>
                
                <li>
                    <a href="../../aql/select/index.html">
                        <i class="fa fa-circle"></i>
                        <span>select</span>
                    </a>
                </li>
                
                <li>
                    <a href="../../aql/from/index.html">
                        <i class="fa fa-circle"></i>
                        <span>from</span>
                    </a>
                </li>
                
                <li>
                    <a href="../../aql/where/index.html">
                        <i class="fa fa-circle"></i>
                        <span>where</span>
                    </a>
                </li>
                
                <li>
                    <a href="../../aql/groupby/index.html">
                        <i class="fa fa-circle"></i>
                        <span>groupBy</span>
                    </a>
                </li>
                
                <li>
                    <a href="../../aql/orderby/index.html">
                        <i class="fa fa-circle"></i>
                        <span>orderBy</span>
                    </a>
                </li>
                
                <li>
                    <a href="../../aql/sum/index.html">
                        <i class="fa fa-circle"></i>
                        <span>sum</span>
                    </a>
                </li>
                
                <li>
                    <a href="../../aql/union/index.html">
                        <i class="fa fa-circle"></i>
                        <span>union</span>
                    </a>
                </li>
                
                <li>
                    <a href="../../aql/custom/index.html">
                        <i class="fa fa-circle"></i>
                        <span>Custom Data Types</span>
                    </a>
                </li>
                
            </ul>
            
        </li>
        
        <li class="sidebar-nav-item">
            <a href="index.html#">
                <span>Generic</span>
                
                <i class="fa fa-angle-right"></i>
                
            </a>
            
            <ul>
                
                <li>
                    <a href="../../generic/coproduct/index.html">
                        <i class="fa fa-circle"></i>
                        <span>Coproduct</span>
                    </a>
                </li>
                
                <li>
                    <a href="../../generic/product/index.html">
                        <i class="fa fa-circle"></i>
                        <span>Product</span>
                    </a>
                </li>
                
            </ul>
            
        </li>
        
        <li class="sidebar-nav-item">
            <a href="index.html#">
                <span>Integrations</span>
                
                <i class="fa fa-angle-right"></i>
                
            </a>
            
            <ul>
                
                <li>
                    <a href="../../integrations/rx2/index.html">
                        <i class="fa fa-circle"></i>
                        <span>Rx2</span>
                    </a>
                </li>
                
                <li>
                    <a href="../../integrations/reactor/index.html">
                        <i class="fa fa-circle"></i>
                        <span>Reactor</span>
                    </a>
                </li>
                
                <li>
                    <a href="../../integrations/kotlinxcoroutines/index.html">
                        <i class="fa fa-circle"></i>
                        <span>kotlinx.coroutines</span>
                    </a>
                </li>
                
                <li>
                    <a href="../../integrations/retrofit/index.html">
                        <i class="fa fa-circle"></i>
                        <span>Retrofit</span>
                    </a>
                </li>
                
                <li>
                    <a href="../../integrations/kindedj/index.html">
                        <i class="fa fa-circle"></i>
                        <span>KindedJ</span>
                    </a>
                </li>
                
            </ul>
            
        </li>
        
        <li class="sidebar-nav-item">
            <a href="index.html#">
                <span>Free</span>
                
                <i class="fa fa-angle-right"></i>
                
            </a>
            
            <ul>
                
                <li>
                    <a href="../../free/free/index.html">
                        <i class="fa fa-circle"></i>
                        <span>Free</span>
                    </a>
                </li>
                
                <li>
                    <a href="../../free/freeapplicative/index.html">
                        <i class="fa fa-circle"></i>
                        <span>FreeApplicative</span>
                    </a>
                </li>
                
                <li>
                    <a href="../../free/cofree/index.html">
                        <i class="fa fa-circle"></i>
                        <span>Cofree</span>
                    </a>
                </li>
                
                <li>
                    <a href="../../free/yoneda/index.html">
                        <i class="fa fa-circle"></i>
                        <span>Yoneda</span>
                    </a>
                </li>
                
                <li>
                    <a href="../../free/coyoneda/index.html">
                        <i class="fa fa-circle"></i>
                        <span>Coyoneda</span>
                    </a>
                </li>
                
            </ul>
            
        </li>
        
        <li class="sidebar-nav-item">
            <a href="index.html#">
                <span>Recursion Schemes</span>
                
                <i class="fa fa-angle-right"></i>
                
            </a>
            
            <ul>
                
                <li>
                    <a href="../../recursion/intro/index.html">
                        <i class="fa fa-circle"></i>
                        <span>Intro</span>
                    </a>
                </li>
                
                <li>
                    <a href="../../recursion/recursive/index.html">
                        <i class="fa fa-circle"></i>
                        <span>Recursive</span>
                    </a>
                </li>
                
                <li>
                    <a href="../../recursion/corecursive/index.html">
                        <i class="fa fa-circle"></i>
                        <span>Corecursive</span>
                    </a>
                </li>
                
                <li>
                    <a href="../../recursion/birecursive/index.html">
                        <i class="fa fa-circle"></i>
                        <span>Birecursive</span>
                    </a>
                </li>
                
                <li>
                    <a href="../../recursion/mu/index.html">
                        <i class="fa fa-circle"></i>
                        <span>Mu</span>
                    </a>
                </li>
                
                <li>
                    <a href="../../recursion/nu/index.html">
                        <i class="fa fa-circle"></i>
                        <span>Nu</span>
                    </a>
                </li>
                
                <li>
                    <a href="../../recursion/fix/index.html">
                        <i class="fa fa-circle"></i>
                        <span>Fix</span>
                    </a>
                </li>
                
            </ul>
            
        </li>
        
        <li class="sidebar-nav-item">
            <a href="index.html#">
                <span>Legal</span>
                
                <i class="fa fa-angle-right"></i>
                
            </a>
            
            <ul>
                
                <li>
                    <a href="../../legal/credits/index.html">
                        <i class="fa fa-circle"></i>
                        <span>Credits</span>
                    </a>
                </li>
                
                <li>
                    <a href="../../legal/licenses/index.html">
                        <i class="fa fa-circle"></i>
                        <span>Licenses</span>
                    </a>
                </li>
                
            </ul>
            
        </li>
        
    </ul>

</div>

    <div id="doc-wrapper">
    <div class="doc-header">
        <button type="button" id="main-toggle" class="sidebar-toggle">
            <i class="fa fa-lg fa-bars menu-icon"></i>
        </button>
        <div class="search-wrapper">
          <input id="docsearch" class="search" placeholder="Search documentation..." type="search"/>
        </div>
        <a target="_blank" href="https://github.com/arrow-kt/arrow/edit/master/modules/docs/arrow-docs/docs/docs/patterns/polymorphicprograms/README.md">
          <i class="fa fa-pencil"></i>
            Edit
        </a>
    </div>
    <div class="doc-content">
        
        <a class="dashingAutolink" name="autolink-117"></a><a class="dashAnchor" name="//apple_ref/cpp/Guide/How%20to%20write%20polymorphic%20programs"></a><h2 id="how-to-write-polymorphic-programs">How to write polymorphic programs</h2>

<p class="advanced">advanced</p>

<p><a href="ru/index.html">Перевод на русский</a></p>

<p>What if we could write apps without caring about the runtime data types used but just about <strong>how the data is operated 
on</strong>?&nbsp;</p>

<p>Let&rsquo;s say we have an application working with RxJava&rsquo;s <code class="highlighter-rouge">Observable</code>. We&rsquo;ll end up having a bunch of chained call stacks 
based on that given data type. But at the end of the day, and for the sake of simplicity, wouldn&rsquo;t  <code class="highlighter-rouge">Observable</code> be just 
like a &ldquo;container&rdquo; with some extra powers?</p>

<p>And same story for other &ldquo;containers&rdquo; like <code class="highlighter-rouge">Flowable</code>, <code class="highlighter-rouge">Deferred</code> (coroutines), <code class="highlighter-rouge">Future</code>, <code class="highlighter-rouge">IO</code>, and many more.</p>

<p>Conceptually, all those types represent an operation (already done or pending to be done), which could support things 
like mapping over the inner value, flatMapping to chain other operations of the same type, zipping it with other 
instances of the same type, and so on.</p>

<p>What if we could write our programs just based on those behaviours in such a declarative style? We could make them be 
agnostic from concrete data types like <code class="highlighter-rouge">Observable</code>. We&rsquo;d just need to be sure that the data types support a certain 
contract, so they are &ldquo;mappable&rdquo;, &ldquo;flatMappable&rdquo;, and so on.</p>

<p>This approach could sound a bit weird or smell to overengineering, but it has some interesting benefits. Let&rsquo;s put our 
eyes on a simple example first and then we talk about those. Deal?</p>

<h3 id="a-canonical-problem">A canonical problem</h3>

<p>I&rsquo;m grabbing the following code samples from my mate <a href="https://twitter.com/raulraja">Ra&uacute;l Raja</a> who helped to polish this post.</p>

<p>Let&rsquo;s say we have a <strong>TODO</strong> app, and we want  to fetch some user <code class="highlighter-rouge">Tasks</code> from a local cache. In case we don&rsquo;t find them
, we&rsquo;ll try to fetch them from a network service. We could have a common contract for for both of the <code class="highlighter-rouge">DataSources</code> that 
would provide a way to retrieve a <code class="highlighter-rouge">List</code> of <code class="highlighter-rouge">Tasks</code> for a given <code class="highlighter-rouge">User</code>, regardless of the source:</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">interface</span> <span class="nc">DataSource</span> <span class="p">{</span>
  <span class="k">fun</span> <span class="nf">allTasksByUser</span><span class="p">(</span><span class="nv">user</span><span class="p">:</span> <span class="nc">User</span><span class="p">):</span> <span class="nc">Observable</span><span class="p">&lt;</span><span class="nc">List</span><span class="err">&lt;</span><span class="nc">Task</span><span class="p">&gt;&gt;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>We&rsquo;ll return <code class="highlighter-rouge">Observable</code> here for simplicity, but it could be <code class="highlighter-rouge">Single</code>, <code class="highlighter-rouge">Maybe</code>, <code class="highlighter-rouge">Flowable</code>, <code class="highlighter-rouge">Deferred</code>, or anything 
else depending on our needs.</p>

<p>Let&rsquo;s add a couple of mock implementations for it, a <strong>local</strong> and a <strong>remote</strong> one.</p>

<pre><code class="language-Kotlin">class LocalDataSource : DataSource {
  private val localCache: Map&lt;User, List&lt;Task&gt;&gt; =
    mapOf(User(UserId(&#34;user1&#34;)) to listOf(Task(&#34;LocalTask assigned to user1&#34;)))

  override fun allTasksByUser(user: User): Observable&lt;List&lt;Task&gt;&gt; = 
    Observable.create { emitter -&gt;
      val cachedUser = localCache[user]
      if (cachedUser != null) {
        emitter.onNext(cachedUser)
      } else {
        emitter.onError(UserNotInLocalStorage(user))
      }
    }
}

class RemoteDataSource : DataSource {
  private val internetStorage: Map&lt;User, List&lt;Task&gt;&gt; =
    mapOf(User(UserId(&#34;user2&#34;)) to listOf(Task(&#34;Remote Task assigned to user2&#34;)))

  override fun allTasksByUser(user: User): Observable&lt;List&lt;Task&gt;&gt; = 
    Observable.create { emitter -&gt;
      val networkUser = internetStorage[user]
      if (networkUser != null) {
        emitter.onNext(networkUser)
      } else {
        emitter.onError(UserNotInRemoteStorage(user))
      }
    }
}
</code></pre>

<p>It&rsquo;s clearly rusty and both implementations are actually the same. It&rsquo;s simply a mocked version of both data sources 
that would ideally retrieve the data from a local cache or a network API. We&rsquo;re using an in memory 
<code class="highlighter-rouge">Map&lt;User, List&lt;Task&gt;&gt;</code> for each one to hold the data.</p>

<p>Since we got two <code class="highlighter-rouge">DataSources</code>, we&rsquo;ll need a way to coordinate both. Let&rsquo;s add the following <code class="highlighter-rouge">Repository</code>:</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">TaskRepository</span><span class="p">(</span><span class="k">private</span> <span class="kd">val</span> <span class="py">localDS</span><span class="p">:</span> <span class="n">DataSource</span><span class="p">,</span> 
                     <span class="k">private</span> <span class="kd">val</span> <span class="py">remoteDS</span><span class="p">:</span> <span class="n">RemoteDataSource</span><span class="p">)</span> <span class="p">{</span>

  <span class="k">fun</span> <span class="nf">allTasksByUser</span><span class="p">(</span><span class="nv">user</span><span class="p">:</span> <span class="nc">User</span><span class="p">):</span> <span class="nc">Observable</span><span class="p">&lt;</span><span class="nc">List</span><span class="err">&lt;</span><span class="nc">Task</span><span class="p">&gt;&gt;</span> <span class="p">=</span>
    <span class="n">localDS</span><span class="p">.</span><span class="n">allTasksByUser</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
      <span class="p">.</span><span class="n">subscribeOn</span><span class="p">(</span><span class="n">Schedulers</span><span class="p">.</span><span class="n">io</span><span class="p">())</span>
      <span class="p">.</span><span class="n">observeOn</span><span class="p">(</span><span class="n">Schedulers</span><span class="p">.</span><span class="n">computation</span><span class="p">())</span>
      <span class="p">.</span><span class="n">onErrorResumeNext</span> <span class="p">{</span> <span class="nv">_</span><span class="p">:</span> <span class="nc">Throwable</span> <span class="p">-&gt;</span> <span class="n">remoteDS</span><span class="p">.</span><span class="n">allTasksByUser</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>It basically tries to load the <code class="highlighter-rouge">List&lt;Task&gt;</code> from the <code class="highlighter-rouge">LocalDataSource</code>, and if it&rsquo;s not found, it will try to fetch it 
from Network using the <code class="highlighter-rouge">RemoteDataSource</code>, as required by our specs.</p>

<p>Let&rsquo;s add a simple dependency provisioning Module. We&rsquo;ll use it to get all our instances up and running in a nested way. 
We&rsquo;ll avoid using any Dependency Injection frameworks&nbsp;:</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">Module</span> <span class="p">{</span>
  <span class="k">private</span> <span class="kd">val</span> <span class="py">localDataSource</span><span class="p">:</span> <span class="n">LocalDataSource</span> <span class="p">=</span> <span class="n">LocalDataSource</span><span class="p">()</span>
  <span class="k">private</span> <span class="kd">val</span> <span class="py">remoteDataSource</span><span class="p">:</span> <span class="n">RemoteDataSource</span> <span class="p">=</span> <span class="n">RemoteDataSource</span><span class="p">()</span>
  <span class="kd">val</span> <span class="py">repository</span><span class="p">:</span> <span class="n">TaskRepository</span> <span class="p">=</span> <span class="n">TaskRepository</span><span class="p">(</span><span class="n">localDataSource</span><span class="p">,</span> <span class="n">remoteDataSource</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<p>And finally, we&rsquo;ll need a simple test to run the whole stack of operations:</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">object</span> <span class="nc">test</span> <span class="p">{</span>

  <span class="nd">@JvmStatic</span>
  <span class="k">fun</span> <span class="nf">main</span><span class="p">(</span><span class="nv">args</span><span class="p">:</span> <span class="nc">Array</span><span class="p">&lt;</span><span class="nc">String</span><span class="p">&gt;):</span> <span class="nc">Unit</span> <span class="p">{</span>
    <span class="kd">val</span> <span class="py">user1</span> <span class="p">=</span> <span class="n">User</span><span class="p">(</span><span class="n">UserId</span><span class="p">(</span><span class="s">&#34;user1&#34;</span><span class="p">))</span>
    <span class="kd">val</span> <span class="py">user2</span> <span class="p">=</span> <span class="n">User</span><span class="p">(</span><span class="n">UserId</span><span class="p">(</span><span class="s">&#34;user2&#34;</span><span class="p">))</span>
    <span class="kd">val</span> <span class="py">user3</span> <span class="p">=</span> <span class="n">User</span><span class="p">(</span><span class="n">UserId</span><span class="p">(</span><span class="s">&#34;unknown user&#34;</span><span class="p">))</span>

    <span class="kd">val</span> <span class="py">dependenciesModule</span> <span class="p">=</span> <span class="n">Module</span><span class="p">()</span>
    <span class="n">dependenciesModule</span><span class="p">.</span><span class="n">run</span> <span class="p">{</span>
      <span class="n">repository</span><span class="p">.</span><span class="n">allTasksByUser</span><span class="p">(</span><span class="n">user1</span><span class="p">).</span><span class="n">subscribe</span><span class="p">({</span> <span class="n">println</span><span class="p">(</span><span class="n">it</span><span class="p">)</span> <span class="p">},</span> <span class="p">{</span> <span class="n">println</span><span class="p">(</span><span class="n">it</span><span class="p">)</span> <span class="p">})</span>
      <span class="n">repository</span><span class="p">.</span><span class="n">allTasksByUser</span><span class="p">(</span><span class="n">user2</span><span class="p">).</span><span class="n">subscribe</span><span class="p">({</span> <span class="n">println</span><span class="p">(</span><span class="n">it</span><span class="p">)</span> <span class="p">},</span> <span class="p">{</span> <span class="n">println</span><span class="p">(</span><span class="n">it</span><span class="p">)</span> <span class="p">})</span>
      <span class="n">repository</span><span class="p">.</span><span class="n">allTasksByUser</span><span class="p">(</span><span class="n">user3</span><span class="p">).</span><span class="n">subscribe</span><span class="p">({</span> <span class="n">println</span><span class="p">(</span><span class="n">it</span><span class="p">)</span> <span class="p">},</span> <span class="p">{</span> <span class="n">println</span><span class="p">(</span><span class="n">it</span><span class="p">)</span> <span class="p">})</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p><a href="https://gist.github.com/JorgeCastilloPrz/05793f11497e0e31f207d2a3e6522bdb">Here you have all the pieces together</a>, just 
in case you want to copy/paste the complete program.</p>

<p>This program composes the execution chain for three different users, and then subscribes to the resulting <a href="https://next.arrow-kt.io/docs/integrations/rx2"><code class="highlighter-rouge">Observable</code></a>.</p>

<p>The first two <code class="highlighter-rouge">Users</code> are available, lucky of us. <code class="highlighter-rouge">User1</code> is available on the local DataSource, and <code class="highlighter-rouge">User2</code> is available 
on the remote one.</p>

<p>We&rsquo;re not so lucky for <code class="highlighter-rouge">User3</code>, since it&rsquo;s not found on the local one. The program will try to load it from the remote 
service, where it&rsquo;s not found either. The search will fail and we&rsquo;ll print the corresponding error on the subscription.</p>

<p>This is what we get printed for the three cases:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&gt; [Task(value=LocalTask assigned to user1)]
&gt; [Task(value=Remote Task assigned to user2)]
&gt; UserNotInRemoteStorage(user=User(userId=UserId(value=unknown user)))
</code></pre></div></div>

<p>This is all what is worth for our canonical example. Let&rsquo;s try to encode it now using a <strong>Functional Programming 
polymorphic style</strong>.</p>

<h3 id="abstracting-out-the-datatypes">Abstracting out the data&nbsp;types</h3>

<p>Our <code class="highlighter-rouge">DataSource</code> contract interface will look like this from now on:</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">interface</span> <span class="nc">DataSource</span><span class="p">&lt;</span><span class="n">F</span><span class="p">&gt;</span> <span class="p">{</span>
  <span class="k">fun</span> <span class="nf">allTasksByUser</span><span class="p">(</span><span class="nv">user</span><span class="p">:</span> <span class="nc">User</span><span class="p">):</span> <span class="nc">Kind</span><span class="p">&lt;</span><span class="nc">F</span><span class="p">,</span> <span class="nc">List</span><span class="err">&lt;</span><span class="nc">Task</span><span class="p">&gt;&gt;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>It&rsquo;s fairly similar, but it has two important differences:</p>

<ul>
  <li>It depends on an <code class="highlighter-rouge">F</code> generic type.</li>
  <li>The return type is <code class="highlighter-rouge">Kind&lt;F, List&lt;Task&gt;&gt;</code>.</li>
</ul>

<p><code class="highlighter-rouge">Kind</code> is basically <a href="../glossary/index.html#type-constructors">the way Arrow encodes something called <strong>Higher Kinded Types</strong></a>. 
Let&rsquo;s learn the concept pretty rapidly with a very basic example.</p>

<p>On <code class="highlighter-rouge">Observable&lt;A&gt;</code>, we have 2 parts:</p>

<ul>
  <li><code class="highlighter-rouge">Observable</code>: The &ldquo;witness&rdquo; type, the container. A fixed type.</li>
  <li><code class="highlighter-rouge">A</code>: The generic type argument. An abstraction, and we can pass any types for it.</li>
</ul>

<p>We&rsquo;re used to abstract over generic types, like <code class="highlighter-rouge">A</code>. We are familiarized with it. Truth is we can also abstract over 
type containers like <code class="highlighter-rouge">Observable</code>. That&rsquo;s why &ldquo;<strong>Higher Kinds</strong>&rdquo; (Higher Kinded Types) exist.</p>

<p>The overall idea is that we can have constructs as <code class="highlighter-rouge">F&lt;A&gt;</code>&nbsp;, where both <code class="highlighter-rouge">F</code> and <code class="highlighter-rouge">A</code> can be generics. That syntax is not 
supported by the Kotlin compiler (<a href="https://github.com/Kotlin/KEEP/pull/87">yet?</a>), so we need to mimic it by using a 
different approach.</p>

<p>Arrow adds support to this by <a href="../glossary/index.html#type-constructors">using an intermediate meta interface called <code class="highlighter-rouge">Kind&lt;F, A&gt;</code></a> 
that holds references to both types and also generates converters at compile time on both directions, so we can go from 
<code class="highlighter-rouge">Kind&lt;Observable, List&lt;Task&gt;&gt;</code> to <code class="highlighter-rouge">Observable&lt;List&lt;Task&gt;&gt;</code> and vice versa. Not ideal, but works for what it&rsquo;s worth.</p>

<p>So, if we take a look at our snippet again:</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">interface</span> <span class="nc">DataSource</span><span class="p">&lt;</span><span class="n">F</span><span class="p">&gt;</span> <span class="p">{</span>
  <span class="k">fun</span> <span class="nf">allTasksByUser</span><span class="p">(</span><span class="nv">user</span><span class="p">:</span> <span class="nc">User</span><span class="p">):</span> <span class="nc">Kind</span><span class="p">&lt;</span><span class="nc">F</span><span class="p">,</span> <span class="nc">List</span><span class="err">&lt;</span><span class="nc">Task</span><span class="p">&gt;&gt;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The <code class="highlighter-rouge">DataSource</code> function <strong>returns a higher kind</strong>: <code class="highlighter-rouge">Kind&lt;F, List&lt;Task&gt;&gt;</code>&nbsp;. It translates to <code class="highlighter-rouge">F&lt;List&lt;Task&gt;&gt;</code>, where <code class="highlighter-rouge">F</code> 
remains generic.</p>

<p>We&rsquo;re just fixing the <code class="highlighter-rouge">List&lt;Task&gt;</code> type here, which is already concrete. In other words, we don&rsquo;t care about what&rsquo;s the 
container type (<code class="highlighter-rouge">F</code>), as long as it keeps  a <code class="highlighter-rouge">List&lt;Task&gt;</code> inside. a.k.a: We leave the slot open <strong>for passing in 
different containers</strong>. Clear enough? Let&rsquo;s keep moving.</p>

<p>Let&rsquo;s take a look at the <code class="highlighter-rouge">DataSource</code> implementations, but this time separately for a more gradual learning. The local 
one first:</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">LocalDataSource</span><span class="p">&lt;</span><span class="n">F</span><span class="p">&gt;(</span><span class="nv">A</span><span class="p">:</span> <span class="nc">ApplicativeError</span><span class="p">&lt;</span><span class="nc">F</span><span class="p">,</span> <span class="nc">Throwable</span><span class="p">&gt;)</span> <span class="p">:</span> <span class="nc">DataSource</span><span class="p">&lt;</span><span class="nc">F</span><span class="p">&gt;,</span> <span class="n">ApplicativeError</span><span class="p">&lt;</span><span class="n">F</span><span class="p">,</span> <span class="n">Throwable</span><span class="p">&gt;</span> <span class="k">by</span> <span class="n">A</span> <span class="p">{</span>
      
    <span class="k">private</span> <span class="kd">val</span> <span class="py">localCache</span><span class="p">:</span> <span class="n">Map</span><span class="p">&lt;</span><span class="n">User</span><span class="p">,</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">Task</span><span class="p">&gt;&gt;</span> <span class="p">=</span>
      <span class="n">mapOf</span><span class="p">(</span><span class="n">User</span><span class="p">(</span><span class="n">UserId</span><span class="p">(</span><span class="s">&#34;user1&#34;</span><span class="p">))</span> <span class="n">to</span> <span class="n">listOf</span><span class="p">(</span><span class="n">Task</span><span class="p">(</span><span class="s">&#34;LocalTask assigned to user1&#34;</span><span class="p">)))</span>

    <span class="k">override</span> <span class="k">fun</span> <span class="nf">allTasksByUser</span><span class="p">(</span><span class="nv">user</span><span class="p">:</span> <span class="nc">User</span><span class="p">):</span> <span class="nc">Kind</span><span class="p">&lt;</span><span class="nc">F</span><span class="p">,</span> <span class="nc">List</span><span class="err">&lt;</span><span class="nc">Task</span><span class="p">&gt;&gt;</span> <span class="p">=</span>
      <span class="n">Option</span><span class="p">.</span><span class="n">fromNullable</span><span class="p">(</span><span class="n">localCache</span><span class="p">[</span><span class="n">user</span><span class="p">]).</span><span class="n">fold</span><span class="p">(</span>
        <span class="p">{</span> <span class="n">raiseError</span><span class="p">(</span><span class="n">UserNotInLocalStorage</span><span class="p">(</span><span class="n">user</span><span class="p">))</span> <span class="p">},</span>
        <span class="p">{</span> <span class="n">just</span><span class="p">(</span><span class="n">it</span><span class="p">)</span> <span class="p">}</span>
      <span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Bunch of new things? Don&rsquo;t be scared, let&rsquo;s go <strong>step by step</strong>.</p>

<p>This <code class="highlighter-rouge">DataSource</code> keeps the generic <code class="highlighter-rouge">F</code> since it implements <code class="highlighter-rouge">DataSource&lt;F&gt;</code>&nbsp;. We wanna be able to pass that type from 
the outside, all the way down.</p>

<p>Now, forget about that probably unfamiliar <a href="https://next.arrow-kt.io/docs/arrow/typeclasses/applicativeerror"><code class="highlighter-rouge">ApplicativeError</code></a> 
thing on the constructor, and focus on the <code class="highlighter-rouge">allTasksByUser()</code> function, just for now. We&rsquo;ll get back to that.</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">override</span> <span class="k">fun</span> <span class="nf">allTasksByUser</span><span class="p">(</span><span class="nv">user</span><span class="p">:</span> <span class="nc">User</span><span class="p">):</span> <span class="nc">Kind</span><span class="p">&lt;</span><span class="nc">F</span><span class="p">,</span> <span class="nc">List</span><span class="err">&lt;</span><span class="nc">Task</span><span class="p">&gt;&gt;</span> <span class="p">=</span>
    <span class="n">Option</span><span class="p">.</span><span class="n">fromNullable</span><span class="p">(</span><span class="n">localCache</span><span class="p">[</span><span class="n">user</span><span class="p">]).</span><span class="n">fold</span><span class="p">(</span>
      <span class="p">{</span> <span class="n">raiseError</span><span class="p">(</span><span class="n">UserNotInLocalStorage</span><span class="p">(</span><span class="n">user</span><span class="p">))</span> <span class="p">},</span>
      <span class="p">{</span> <span class="n">just</span><span class="p">(</span><span class="n">it</span><span class="p">)</span> <span class="p">}</span>
    <span class="p">)</span>
</code></pre></div></div>

<p>As you see, it returns (one more time) <code class="highlighter-rouge">Kind&lt;F, List&lt;Task&gt;&gt;</code>. So we still don&rsquo;t care about what the container <code class="highlighter-rouge">F</code> is, as 
long as it contains a <code class="highlighter-rouge">List&lt;Task&gt;</code>.</p>

<p>But we have a problem. Depending on whether we can find the <code class="highlighter-rouge">Tasks</code> for the given user on the local cache or not, we 
might want to <strong>notify an error</strong> (<code class="highlighter-rouge">Tasks</code> not found), or <strong>return the Tasks already wrapped into <code class="highlighter-rouge">F</code></strong> (<code class="highlighter-rouge">Tasks</code> found).</p>

<p>And for both things we must return: <code class="highlighter-rouge">Kind&lt;F, List&lt;Task&gt;&gt;</code>.</p>

<p>In other words: there&rsquo;s a type <strong>we still don&rsquo;t know anything about: <code class="highlighter-rouge">F</code></strong> and we need a way to return an error wrapped 
into it, and also a way to construct an instance of it wrapping a successful value. Sounds impossible?.&nbsp;</p>

<p>Let&rsquo;s go back to the class declaration and find that <a href="https://next.arrow-kt.io/docs/arrow/typeclasses/applicativeerror"><code class="highlighter-rouge">ApplicativeError</code></a> 
being passed on construction and then used as a delegate for the class (<code class="highlighter-rouge">by A</code>).</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">LocalDataSource</span><span class="p">&lt;</span><span class="n">F</span><span class="p">&gt;(</span><span class="nv">A</span><span class="p">:</span> <span class="nc">ApplicativeError</span><span class="p">&lt;</span><span class="nc">F</span><span class="p">,</span> <span class="nc">Throwable</span><span class="p">&gt;)</span> <span class="p">:</span> <span class="nc">DataSource</span><span class="p">&lt;</span><span class="nc">F</span><span class="p">&gt;,</span> <span class="n">ApplicativeError</span><span class="p">&lt;</span><span class="n">F</span><span class="p">,</span> <span class="n">Throwable</span><span class="p">&gt;</span> <span class="k">by</span> <span class="n">A</span> <span class="p">{</span>
    <span class="c1">//...</span>
<span class="p">}</span>
</code></pre></div></div>

<p><a href="https://next.arrow-kt.io/docs/arrow/typeclasses/applicativeerror"><code class="highlighter-rouge">ApplicativeError</code></a> extends from <a href="https://next.arrow-kt.io/docs/arrow/typeclasses/applicative"><code class="highlighter-rouge">Applicative</code></a>, 
and both are <a href="https://next.arrow-kt.io/docs/typeclasses/intro"><strong>Typeclasses</strong></a>.</p>

<p><strong>Typeclasses define behaviors (contracts)</strong>. They&rsquo;re basically encoded as interfaces that work over a generic argument, 
as in <a href="https://next.arrow-kt.io/docs/arrow/typeclasses/monad"><code class="highlighter-rouge">Monad&lt;F&gt;</code></a>&nbsp;, <a href="https://next.arrow-kt.io/docs/arrow/typeclasses/functor"><code class="highlighter-rouge">Functor&lt;F&gt;</code></a> 
and many more. That <code class="highlighter-rouge">F</code> is the data type. So we will be able to pass types like <a href="https://next.arrow-kt.io/docs/arrow/core/either"><code class="highlighter-rouge">Either</code></a>
, <a href="https://next.arrow-kt.io/docs/arrow/core/option"><code class="highlighter-rouge">Option</code></a>, <a href="https://next.arrow-kt.io/docs/effects/io"><code class="highlighter-rouge">IO</code></a>, <a href="https://next.arrow-kt.io/docs/integrations/rx2"><code class="highlighter-rouge">Observable</code></a>, 
<a href="https://next.arrow-kt.io/docs/integrations/rx2"><code class="highlighter-rouge">Flowable</code></a> and many more for it.</p>

<p>Don&rsquo;t worry if you don&rsquo;t know about some of them yet. Data types like <code class="highlighter-rouge">Either</code>, <code class="highlighter-rouge">Option</code> or <code class="highlighter-rouge">IO</code> are particular from 
Functional Programming and you probably don&rsquo;t need to know more about them yet.</p>

<p>So, back to our two problems:</p>

<ul>
  <li><strong>Wrapping a successful value into an instance of <code class="highlighter-rouge">Kind&lt;F, List&lt;Task&gt;&gt;</code></strong></li>
</ul>

<p>We can rely on a typeclass for this: <a href="https://next.arrow-kt.io/docs/arrow/typeclasses/applicative"><code class="highlighter-rouge">Applicative</code></a>. Since <a href="https://next.arrow-kt.io/docs/arrow/typeclasses/applicativeerror"><code class="highlighter-rouge">ApplicativeError</code></a> 
extends from it, we can delegate to it. We&rsquo;re delegating our class on it, so we can use its features out of the box.</p>

<p><a href="https://next.arrow-kt.io/docs/arrow/typeclasses/applicative"><code class="highlighter-rouge">Applicative</code></a> provides the <code class="highlighter-rouge">just(a)</code> function. <code class="highlighter-rouge">just(a)</code> <strong>wraps 
a value into the context of any Higher Kind</strong>. So If we have an <code class="highlighter-rouge">Applicative&lt;F&gt;</code>, it could call <code class="highlighter-rouge">just(a)</code> to wrap the 
value into the container <code class="highlighter-rouge">F</code>, regardless of which one is it. Let&rsquo;s say it&rsquo;s <code class="highlighter-rouge">Observable</code>, we&rsquo;ll have an 
<code class="highlighter-rouge">Applicative&lt;Observable&gt;</code>, which will know how to wrap <code class="highlighter-rouge">a</code> into an <code class="highlighter-rouge">Observable</code> like <code class="highlighter-rouge">Observable.just(a)</code>.</p>

<ul>
  <li><strong>Wrapping an error into an instance of <code class="highlighter-rouge">Kind&lt;F, List&lt;Task&gt;&gt;</code></strong></li>
</ul>

<p>We can use <a href="https://next.arrow-kt.io/docs/arrow/typeclasses/applicativeerror"><code class="highlighter-rouge">ApplicativeError</code></a> for that. It brings the 
function <code class="highlighter-rouge">raiseError(e)</code> into scope. <code class="highlighter-rouge">raiseError(e)</code> basically wraps an error into the <code class="highlighter-rouge">F</code> container. For the 
<code class="highlighter-rouge">Observable</code> example, raising the error would end up doing something like <code class="highlighter-rouge">Observable.error&lt;A&gt;(t)</code>, where <code class="highlighter-rouge">t</code> is a 
<code class="highlighter-rouge">Throwable</code>, since we&rsquo;re declaring our error type when we declare the typeclass as <code class="highlighter-rouge">ApplicativeError&lt;F, Throwable&gt;</code>.</p>

<p>Let&rsquo;s get back to our abstracted <code class="highlighter-rouge">LocalDataSource&lt;F&gt;</code> implementation.</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">LocalDataSource</span><span class="p">&lt;</span><span class="n">F</span><span class="p">&gt;(</span><span class="nv">A</span><span class="p">:</span> <span class="nc">ApplicativeError</span><span class="p">&lt;</span><span class="nc">F</span><span class="p">,</span> <span class="nc">Throwable</span><span class="p">&gt;)</span> <span class="p">:</span> 
    <span class="nc">DataSource</span><span class="p">&lt;</span><span class="nc">F</span><span class="p">&gt;,</span> <span class="n">ApplicativeError</span><span class="p">&lt;</span><span class="n">F</span><span class="p">,</span> <span class="n">Throwable</span><span class="p">&gt;</span> <span class="k">by</span> <span class="n">A</span> <span class="p">{</span>
      
    <span class="k">private</span> <span class="kd">val</span> <span class="py">localCache</span><span class="p">:</span> <span class="n">Map</span><span class="p">&lt;</span><span class="n">User</span><span class="p">,</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">Task</span><span class="p">&gt;&gt;</span> <span class="p">=</span>
      <span class="n">mapOf</span><span class="p">(</span><span class="n">User</span><span class="p">(</span><span class="n">UserId</span><span class="p">(</span><span class="s">&#34;user1&#34;</span><span class="p">))</span> <span class="n">to</span> <span class="n">listOf</span><span class="p">(</span><span class="n">Task</span><span class="p">(</span><span class="s">&#34;LocalTask assigned to user1&#34;</span><span class="p">)))</span>

    <span class="k">override</span> <span class="k">fun</span> <span class="nf">allTasksByUser</span><span class="p">(</span><span class="nv">user</span><span class="p">:</span> <span class="nc">User</span><span class="p">):</span> <span class="nc">Kind</span><span class="p">&lt;</span><span class="nc">F</span><span class="p">,</span> <span class="nc">List</span><span class="err">&lt;</span><span class="nc">Task</span><span class="p">&gt;&gt;</span> <span class="p">=</span>
      <span class="n">Option</span><span class="p">.</span><span class="n">fromNullable</span><span class="p">(</span><span class="n">localCache</span><span class="p">[</span><span class="n">user</span><span class="p">]).</span><span class="n">fold</span><span class="p">(</span>
        <span class="p">{</span> <span class="n">raiseError</span><span class="p">(</span><span class="n">UserNotInLocalStorage</span><span class="p">(</span><span class="n">user</span><span class="p">))</span> <span class="p">},</span>
        <span class="p">{</span> <span class="n">just</span><span class="p">(</span><span class="n">it</span><span class="p">)</span> <span class="p">}</span>
      <span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The in memory map remains the same, but the function does a couple things probably new to you:</p>

<ul>
  <li>
    <p>It tries to load the <code class="highlighter-rouge">Tasks</code> from the local cache, and since that returns a nullable (because the <code class="highlighter-rouge">Tasks</code> could not be 
found), we are going to model that using an <a href="https://next.arrow-kt.io/docs/arrow/core/option"><code class="highlighter-rouge">Option</code></a>. In case you&rsquo;re not 
aware of how <a href="https://next.arrow-kt.io/docs/arrow/core/option"><code class="highlighter-rouge">Option</code></a> works, it models presence vs absence of a value. A 
value that is wrapped inside of it.</p>
  </li>
  <li>
    <p>After getting our optional value, we <code class="highlighter-rouge">fold</code> over it. Folding is just equivalent to a when statement over the optional 
value. When it&rsquo;s <strong>absent</strong>, it wraps an error into the <code class="highlighter-rouge">F</code> data type (first lambda passed in). And when it&rsquo;s 
<strong>present</strong> it constructs an instance of the <code class="highlighter-rouge">F</code> data type wrapping it (second lambda). For both cases, it uses the 
<a href="https://next.arrow-kt.io/docs/arrow/typeclasses/applicativeerror"><code class="highlighter-rouge">ApplicativeError</code></a> features mentioned before: 
<code class="highlighter-rouge">raiseError()</code> and <code class="highlighter-rouge">just()</code>.</p>
  </li>
</ul>

<p>With this, we&rsquo;ve basically abstracted away our data source implementation so it doesn&rsquo;t know about which container it&rsquo;s 
using for the type <code class="highlighter-rouge">F</code>. And we have been able to do it thanks to the abstractions defined by the typeclasses.</p>

<p>The network <code class="highlighter-rouge">DataSource</code> implementation would look similar:</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">RemoteDataSource</span><span class="p">&lt;</span><span class="n">F</span><span class="p">&gt;(</span><span class="nv">A</span><span class="p">:</span> <span class="nc">Async</span><span class="p">&lt;</span><span class="nc">F</span><span class="p">&gt;)</span> <span class="p">:</span> <span class="nc">DataSource</span><span class="p">&lt;</span><span class="nc">F</span><span class="p">&gt;,</span> <span class="n">Async</span><span class="p">&lt;</span><span class="n">F</span><span class="p">&gt;</span> <span class="k">by</span> <span class="n">A</span> <span class="p">{</span>
  <span class="k">private</span> <span class="kd">val</span> <span class="py">internetStorage</span><span class="p">:</span> <span class="n">Map</span><span class="p">&lt;</span><span class="n">User</span><span class="p">,</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">Task</span><span class="p">&gt;&gt;</span> <span class="p">=</span>
    <span class="n">mapOf</span><span class="p">(</span><span class="n">User</span><span class="p">(</span><span class="n">UserId</span><span class="p">(</span><span class="s">&#34;user2&#34;</span><span class="p">))</span> <span class="n">to</span> <span class="n">listOf</span><span class="p">(</span><span class="n">Task</span><span class="p">(</span><span class="s">&#34;Remote Task assigned to user2&#34;</span><span class="p">)))</span>

  <span class="k">override</span> <span class="k">fun</span> <span class="nf">allTasksByUser</span><span class="p">(</span><span class="nv">user</span><span class="p">:</span> <span class="nc">User</span><span class="p">):</span> <span class="nc">Kind</span><span class="p">&lt;</span><span class="nc">F</span><span class="p">,</span> <span class="nc">List</span><span class="err">&lt;</span><span class="nc">Task</span><span class="p">&gt;&gt;</span> <span class="p">=</span>
    <span class="n">async</span> <span class="p">{</span> <span class="n">callback</span><span class="p">:</span> <span class="p">(</span><span class="n">Either</span><span class="p">&lt;</span><span class="n">Throwable</span><span class="p">,</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">Task</span><span class="p">&gt;&gt;)</span> <span class="p">-&gt;</span> <span class="n">Unit</span> <span class="p">-&gt;</span>
      <span class="n">Option</span><span class="p">.</span><span class="n">fromNullable</span><span class="p">(</span><span class="n">internetStorage</span><span class="p">[</span><span class="n">user</span><span class="p">]).</span><span class="n">fold</span><span class="p">(</span>
        <span class="p">{</span> <span class="n">callback</span><span class="p">(</span><span class="n">UserNotInRemoteStorage</span><span class="p">(</span><span class="n">user</span><span class="p">).</span><span class="n">left</span><span class="p">())</span> <span class="p">},</span>
        <span class="p">{</span> <span class="n">callback</span><span class="p">(</span><span class="n">it</span><span class="p">.</span><span class="n">right</span><span class="p">())</span> <span class="p">}</span>
      <span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>This time there&rsquo;s a subtle difference: Instead of delegating into an instance of <a href="https://next.arrow-kt.io/docs/arrow/typeclasses/applicativeerror"><code class="highlighter-rouge">ApplicativeError</code></a> 
as before, we&rsquo;ll use a different typeclass: <a href="../../effects/async/index.html"><code class="highlighter-rouge">Async</code></a>.</p>

<p>That&rsquo;s because of the asynchronous nature of a network call. We want to code it in an asynchronous way, so we&rsquo;ll 
delegate its async requirements into a typeclass that is thought for it.</p>

<p><a href="../../effects/async/index.html"><code class="highlighter-rouge">Async</code></a> models asynchronous operations. So it&rsquo;s able to model any 
operations that are based on callbacks. Note that we still don&rsquo;t know about the concrete data types to use, but about 
the problem, which <strong>is asynchronous by nature</strong>. Therefore we use a Typeclass that encodes that problematic to solve 
it.</p>

<p>So, zooming in a bit into the function:</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">override</span> <span class="k">fun</span> <span class="nf">allTasksByUser</span><span class="p">(</span><span class="nv">user</span><span class="p">:</span> <span class="nc">User</span><span class="p">):</span> <span class="nc">Kind</span><span class="p">&lt;</span><span class="nc">F</span><span class="p">,</span> <span class="nc">List</span><span class="err">&lt;</span><span class="nc">Task</span><span class="p">&gt;&gt;</span> <span class="p">=</span>
    <span class="n">async</span> <span class="p">{</span> <span class="n">callback</span><span class="p">:</span> <span class="p">(</span><span class="n">Either</span><span class="p">&lt;</span><span class="n">Throwable</span><span class="p">,</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">Task</span><span class="p">&gt;&gt;)</span> <span class="p">-&gt;</span> <span class="n">Unit</span> <span class="p">-&gt;</span>
      <span class="n">Option</span><span class="p">.</span><span class="n">fromNullable</span><span class="p">(</span><span class="n">internetStorage</span><span class="p">[</span><span class="n">user</span><span class="p">]).</span><span class="n">fold</span><span class="p">(</span>
        <span class="p">{</span> <span class="n">callback</span><span class="p">(</span><span class="n">UserNotInRemoteStorage</span><span class="p">(</span><span class="n">user</span><span class="p">).</span><span class="n">left</span><span class="p">())</span> <span class="p">},</span>
        <span class="p">{</span> <span class="n">callback</span><span class="p">(</span><span class="n">it</span><span class="p">.</span><span class="n">right</span><span class="p">())</span> <span class="p">}</span>
      <span class="p">)</span>
    <span class="p">}</span>
</code></pre></div></div>

<p>We can use the <code class="highlighter-rouge">async {}</code> function provided by the <a href="../../effects/async/index.html"><code class="highlighter-rouge">Async</code></a> typeclass to 
model our operation and create an instance of the type <code class="highlighter-rouge">Kind&lt;F, List&lt;Task&gt;&gt;</code> that will be resolved asynchronously.</p>

<p>If we were using a fixed data type like <code class="highlighter-rouge">Observable</code>, <code class="highlighter-rouge">Async.async {}</code> would be equivalent to <code class="highlighter-rouge">Observable.create()</code>, in 
terms of building up an operation that can be bridged from synchronous or asynchronous code, i.e. <code class="highlighter-rouge">Thread</code> or 
<code class="highlighter-rouge">AsyncTask</code>.</p>

<p>The <code class="highlighter-rouge">callback</code> parameter is used to wire back the real resulting callbacks into the <code class="highlighter-rouge">F</code> container (higher kind type) 
context.</p>

<p>With this we have our <code class="highlighter-rouge">RemoteDataSource</code> also abstracted away and depending on a still unknown container type <code class="highlighter-rouge">F</code>.</p>

<p>Let&rsquo;s go up one level to take a look at the repo. If you can remember, we need to search for the user <code class="highlighter-rouge">Tasks</code> on the 
<code class="highlighter-rouge">LocalDataSource</code> first, and if they&rsquo;re not available, try to fetch them from the <code class="highlighter-rouge">RemoteLocalDataSource</code>.</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">TaskRepository</span><span class="p">&lt;</span><span class="n">F</span><span class="p">&gt;(</span>
  <span class="k">private</span> <span class="kd">val</span> <span class="py">localDS</span><span class="p">:</span> <span class="n">DataSource</span><span class="p">&lt;</span><span class="n">F</span><span class="p">&gt;,</span>
  <span class="k">private</span> <span class="kd">val</span> <span class="py">remoteDS</span><span class="p">:</span> <span class="n">RemoteDataSource</span><span class="p">&lt;</span><span class="n">F</span><span class="p">&gt;,</span>
  <span class="nv">AE</span><span class="p">:</span> <span class="nc">ApplicativeError</span><span class="p">&lt;</span><span class="nc">F</span><span class="p">,</span> <span class="nc">Throwable</span><span class="p">&gt;)</span> <span class="p">:</span> <span class="nc">ApplicativeError</span><span class="p">&lt;</span><span class="nc">F</span><span class="p">,</span> <span class="nc">Throwable</span><span class="p">&gt;</span> <span class="k">by</span> <span class="n">AE</span> <span class="p">{</span>

  <span class="k">fun</span> <span class="nf">allTasksByUser</span><span class="p">(</span><span class="nv">user</span><span class="p">:</span> <span class="nc">User</span><span class="p">):</span> <span class="nc">Kind</span><span class="p">&lt;</span><span class="nc">F</span><span class="p">,</span> <span class="nc">List</span><span class="err">&lt;</span><span class="nc">Task</span><span class="p">&gt;&gt;</span> <span class="p">=</span>
    <span class="n">localDS</span><span class="p">.</span><span class="n">allTasksByUser</span><span class="p">(</span><span class="n">user</span><span class="p">).</span><span class="n">handleErrorWith</span> <span class="p">{</span>
      <span class="k">when</span> <span class="p">(</span><span class="n">it</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">is</span> <span class="n">UserNotInLocalStorage</span> <span class="p">-&gt;</span> <span class="n">remoteDS</span><span class="p">.</span><span class="n">allTasksByUser</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
        <span class="k">else</span> <span class="p">-&gt;</span> <span class="n">raiseError</span><span class="p">(</span><span class="n">UnknownError</span><span class="p">(</span><span class="n">it</span><span class="p">))</span>
      <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p><a href="../../arrow/typeclasses/applicativeerror/index.html"><code class="highlighter-rouge">ApplicativeError&lt;F, Throwable&gt;</code></a> is back! It also brings 
an extension function into scope called <code class="highlighter-rouge">handleErrorWith()</code> that works over any Higher Kind receiver.</p>

<p>It&rsquo;s encoded like:</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">fun</span> <span class="p">&lt;</span><span class="nc">A</span><span class="p">&gt;</span> <span class="nf">Kind</span><span class="p">&lt;</span><span class="n">F</span><span class="p">,</span> <span class="n">A</span><span class="p">&gt;.</span><span class="n">handleErrorWith</span><span class="p">(</span><span class="n">f</span><span class="p">:</span> <span class="p">(</span><span class="n">E</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">Kind</span><span class="p">&lt;</span><span class="n">F</span><span class="p">,</span> <span class="n">A</span><span class="p">&gt;):</span> <span class="nc">Kind</span><span class="p">&lt;</span><span class="nc">F</span><span class="p">,</span> <span class="nc">A</span><span class="p">&gt;</span>
</code></pre></div></div>

<p>Since the call <code class="highlighter-rouge">localDS.allTasksByUser(user)</code> returns <code class="highlighter-rouge">Kind&lt;F, List&lt;Task&gt;&gt;</code>, which would stand for <code class="highlighter-rouge">F&lt;List&lt;Task&gt;&gt;</code> where 
<code class="highlighter-rouge">F</code> remains generic, we can call the <code class="highlighter-rouge">handleErrorWith()</code> function on top of it.</p>

<p><code class="highlighter-rouge">handleErrorWith()</code> allows you to react to errors using the passed in lambda. Let&rsquo;s zoom in to the function:</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">fun</span> <span class="nf">allTasksByUser</span><span class="p">(</span><span class="nv">user</span><span class="p">:</span> <span class="nc">User</span><span class="p">):</span> <span class="nc">Kind</span><span class="p">&lt;</span><span class="nc">F</span><span class="p">,</span> <span class="nc">List</span><span class="err">&lt;</span><span class="nc">Task</span><span class="p">&gt;&gt;</span> <span class="p">=</span>
    <span class="n">localDS</span><span class="p">.</span><span class="n">allTasksByUser</span><span class="p">(</span><span class="n">user</span><span class="p">).</span><span class="n">handleErrorWith</span> <span class="p">{</span>
      <span class="k">when</span> <span class="p">(</span><span class="n">it</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">is</span> <span class="n">UserNotInLocalStorage</span> <span class="p">-&gt;</span> <span class="n">remoteDS</span><span class="p">.</span><span class="n">allTasksByUser</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
        <span class="k">else</span> <span class="p">-&gt;</span> <span class="n">raiseError</span><span class="p">(</span><span class="n">UnknownError</span><span class="p">(</span><span class="n">it</span><span class="p">))</span>
      <span class="p">}</span>
    <span class="p">}</span>
</code></pre></div></div>

<p>So we basically get back the result of the first operation unless it throws an exception, which will be handled by the 
lambda block. In case the error has the type <code class="highlighter-rouge">UserNotInLocalStorage</code>, we try to search for the <code class="highlighter-rouge">Tasks</code> on the remote 
<code class="highlighter-rouge">DataSource</code>. In any other cases, we raise (wrap) an unknown error into the <code class="highlighter-rouge">F</code> container type.</p>

<p>The dependency provisioning module remains very similar:</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">Module</span><span class="p">&lt;</span><span class="n">F</span><span class="p">&gt;(</span><span class="nv">A</span><span class="p">:</span> <span class="nc">Async</span><span class="p">&lt;</span><span class="nc">F</span><span class="p">&gt;)</span> <span class="p">{</span>
  <span class="k">private</span> <span class="kd">val</span> <span class="py">localDataSource</span><span class="p">:</span> <span class="n">LocalDataSource</span><span class="p">&lt;</span><span class="n">F</span><span class="p">&gt;</span> <span class="p">=</span> <span class="n">LocalDataSource</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
  <span class="k">private</span> <span class="kd">val</span> <span class="py">remoteDataSource</span><span class="p">:</span> <span class="n">RemoteDataSource</span><span class="p">&lt;</span><span class="n">F</span><span class="p">&gt;</span> <span class="p">=</span> <span class="n">RemoteDataSource</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
  <span class="kd">val</span> <span class="py">repository</span><span class="p">:</span> <span class="n">TaskRepository</span><span class="p">&lt;</span><span class="n">F</span><span class="p">&gt;</span> <span class="p">=</span> 
      <span class="n">TaskRepository</span><span class="p">(</span><span class="n">localDataSource</span><span class="p">,</span> <span class="n">remoteDataSource</span><span class="p">,</span> <span class="n">A</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The only difference is that now it&rsquo;s abstracted away and depends on <code class="highlighter-rouge">F</code>, which stays polymorphic. I&rsquo;ve intentionally 
obviated this before to avoid noise, but <a href="../../effects/async/index.html"><code class="highlighter-rouge">Async</code></a> ultimately extends 
from <a href="../../arrow/typeclasses/applicativeerror/index.html"><code class="highlighter-rouge">ApplicativeError</code></a>, so we can use an instance of it 
to solve the concerns we have at all the nested levels, and pass it all the way down as you can see on the module.</p>

<h3 id="testing-polymorphism">Testing polymorphism</h3>

<p>We have finally got to the point where <strong>our complete app is abstracted away from any concrete data type containers</strong> 
(<code class="highlighter-rouge">F</code>) and we can focus on testing its polymorphism using the runtime. We&rsquo;ll test the same code passing in different data 
types for the type <code class="highlighter-rouge">F</code>. The scenario is the same we had when we were plainly using <code class="highlighter-rouge">Observable</code>.</p>

<p>We&rsquo;re now in the program&rsquo;s edge, where we are already out of any abstraction boundaries, and where we are in charge to 
pass in the implementation details.</p>

<p>Let&rsquo;s use RxJava <code class="highlighter-rouge">Single</code> as the container <code class="highlighter-rouge">F</code> to start with.</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">object</span> <span class="nc">test</span> <span class="p">{</span>

  <span class="nd">@JvmStatic</span>
  <span class="k">fun</span> <span class="nf">main</span><span class="p">(</span><span class="nv">args</span><span class="p">:</span> <span class="nc">Array</span><span class="p">&lt;</span><span class="nc">String</span><span class="p">&gt;):</span> <span class="nc">Unit</span> <span class="p">{</span>
    <span class="kd">val</span> <span class="py">user1</span> <span class="p">=</span> <span class="n">User</span><span class="p">(</span><span class="n">UserId</span><span class="p">(</span><span class="s">&#34;user1&#34;</span><span class="p">))</span>
    <span class="kd">val</span> <span class="py">user2</span> <span class="p">=</span> <span class="n">User</span><span class="p">(</span><span class="n">UserId</span><span class="p">(</span><span class="s">&#34;user2&#34;</span><span class="p">))</span>
    <span class="kd">val</span> <span class="py">user3</span> <span class="p">=</span> <span class="n">User</span><span class="p">(</span><span class="n">UserId</span><span class="p">(</span><span class="s">&#34;unknown user&#34;</span><span class="p">))</span>

    <span class="kd">val</span> <span class="py">singleModule</span> <span class="p">=</span> <span class="n">Module</span><span class="p">(</span><span class="n">SingleK</span><span class="p">.</span><span class="n">async</span><span class="p">())</span>
    <span class="n">singleModule</span><span class="p">.</span><span class="n">run</span> <span class="p">{</span>
      <span class="n">repository</span><span class="p">.</span><span class="n">allTasksByUser</span><span class="p">(</span><span class="n">user1</span><span class="p">).</span><span class="n">fix</span><span class="p">().</span><span class="n">single</span><span class="p">.</span><span class="n">subscribe</span><span class="p">(</span><span class="o">::</span><span class="n">println</span><span class="p">,</span> <span class="o">::</span><span class="n">println</span><span class="p">)</span>
      <span class="n">repository</span><span class="p">.</span><span class="n">allTasksByUser</span><span class="p">(</span><span class="n">user2</span><span class="p">).</span><span class="n">fix</span><span class="p">().</span><span class="n">single</span><span class="p">.</span><span class="n">subscribe</span><span class="p">(</span><span class="o">::</span><span class="n">println</span><span class="p">,</span> <span class="o">::</span><span class="n">println</span><span class="p">)</span>
      <span class="n">repository</span><span class="p">.</span><span class="n">allTasksByUser</span><span class="p">(</span><span class="n">user3</span><span class="p">).</span><span class="n">fix</span><span class="p">().</span><span class="n">single</span><span class="p">.</span><span class="n">subscribe</span><span class="p">(</span><span class="o">::</span><span class="n">println</span><span class="p">,</span> <span class="o">::</span><span class="n">println</span><span class="p">)</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Arrow provides wrappers over some well known library data types for compatibility, so there&rsquo;s a handy <a href="../../integrations/rx2/index.html"><code class="highlighter-rouge">SingleK</code></a> 
wrapper available for it. These wrappers <strong>enable the data types as Higher Kinds</strong> to be able to use them with 
typeclasses.</p>

<p>This test will print:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[Task(value=LocalTask assigned to user1)]
[Task(value=Remote Task assigned to user2)]
UserNotInRemoteStorage(user=User(userId=UserId(value=unknown user)))
</code></pre></div></div>

<p>Same results than the one using a fixed <code class="highlighter-rouge">Observable</code>. 🎉</p>

<p>Let&rsquo;s move on to <code class="highlighter-rouge">Maybe</code>, for which we have a <a href="../../integrations/rx2/index.html"><code class="highlighter-rouge">MaybeK</code></a> wrapper also:</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@JvmStatic</span>
<span class="k">fun</span> <span class="nf">main</span><span class="p">(</span><span class="nv">args</span><span class="p">:</span> <span class="nc">Array</span><span class="p">&lt;</span><span class="nc">String</span><span class="p">&gt;):</span> <span class="nc">Unit</span> <span class="p">{</span>
    <span class="kd">val</span> <span class="py">user1</span> <span class="p">=</span> <span class="n">User</span><span class="p">(</span><span class="n">UserId</span><span class="p">(</span><span class="s">&#34;user1&#34;</span><span class="p">))</span>
    <span class="kd">val</span> <span class="py">user2</span> <span class="p">=</span> <span class="n">User</span><span class="p">(</span><span class="n">UserId</span><span class="p">(</span><span class="s">&#34;user2&#34;</span><span class="p">))</span>
    <span class="kd">val</span> <span class="py">user3</span> <span class="p">=</span> <span class="n">User</span><span class="p">(</span><span class="n">UserId</span><span class="p">(</span><span class="s">&#34;unknown user&#34;</span><span class="p">))</span>

    <span class="kd">val</span> <span class="py">maybeModule</span> <span class="p">=</span> <span class="n">Module</span><span class="p">(</span><span class="n">MaybeK</span><span class="p">.</span><span class="n">async</span><span class="p">())</span>
    <span class="n">maybeModule</span><span class="p">.</span><span class="n">run</span> <span class="p">{</span>
      <span class="n">repository</span><span class="p">.</span><span class="n">allTasksByUser</span><span class="p">(</span><span class="n">user1</span><span class="p">).</span><span class="n">fix</span><span class="p">().</span><span class="n">maybe</span><span class="p">.</span><span class="n">subscribe</span><span class="p">(</span><span class="o">::</span><span class="n">println</span><span class="p">,</span> <span class="o">::</span><span class="n">println</span><span class="p">)</span>
      <span class="n">repository</span><span class="p">.</span><span class="n">allTasksByUser</span><span class="p">(</span><span class="n">user2</span><span class="p">).</span><span class="n">fix</span><span class="p">().</span><span class="n">maybe</span><span class="p">.</span><span class="n">subscribe</span><span class="p">(</span><span class="o">::</span><span class="n">println</span><span class="p">,</span> <span class="o">::</span><span class="n">println</span><span class="p">)</span>
      <span class="n">repository</span><span class="p">.</span><span class="n">allTasksByUser</span><span class="p">(</span><span class="n">user3</span><span class="p">).</span><span class="n">fix</span><span class="p">().</span><span class="n">maybe</span><span class="p">.</span><span class="n">subscribe</span><span class="p">(</span><span class="o">::</span><span class="n">println</span><span class="p">,</span> <span class="o">::</span><span class="n">println</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Same result is printed, but this time running using a different data type:</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">[Task(value=LocalTask assigned to user1)]</span>
<span class="na">[Task(value=Remote Task assigned to user2)]</span>
<span class="n">UserNotInRemoteStorage</span><span class="p">(</span><span class="n">user</span><span class="p">=</span><span class="n">User</span><span class="p">(</span><span class="n">userId</span><span class="p">=</span><span class="n">UserId</span><span class="p">(</span><span class="n">value</span><span class="p">=</span><span class="n">unknown</span> <span class="n">user</span><span class="p">)))</span>
</code></pre></div></div>

<p>What about <a href="../../integrations/rx2/index.html"><code class="highlighter-rouge">ObservableK</code></a> / <a href="../../integrations/rx2/index.html"><code class="highlighter-rouge">FlowableK</code></a>
? Let&rsquo;s try:</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">object</span> <span class="nc">test</span> <span class="p">{</span>

  <span class="nd">@JvmStatic</span>
  <span class="k">fun</span> <span class="nf">main</span><span class="p">(</span><span class="nv">args</span><span class="p">:</span> <span class="nc">Array</span><span class="p">&lt;</span><span class="nc">String</span><span class="p">&gt;):</span> <span class="nc">Unit</span> <span class="p">{</span>
    <span class="kd">val</span> <span class="py">user1</span> <span class="p">=</span> <span class="n">User</span><span class="p">(</span><span class="n">UserId</span><span class="p">(</span><span class="s">&#34;user1&#34;</span><span class="p">))</span>
    <span class="kd">val</span> <span class="py">user2</span> <span class="p">=</span> <span class="n">User</span><span class="p">(</span><span class="n">UserId</span><span class="p">(</span><span class="s">&#34;user2&#34;</span><span class="p">))</span>
    <span class="kd">val</span> <span class="py">user3</span> <span class="p">=</span> <span class="n">User</span><span class="p">(</span><span class="n">UserId</span><span class="p">(</span><span class="s">&#34;unknown user&#34;</span><span class="p">))</span>

    <span class="kd">val</span> <span class="py">observableModule</span> <span class="p">=</span> <span class="n">Module</span><span class="p">(</span><span class="n">ObservableK</span><span class="p">.</span><span class="n">async</span><span class="p">())</span>
    <span class="n">observableModule</span><span class="p">.</span><span class="n">run</span> <span class="p">{</span>
      <span class="n">repository</span><span class="p">.</span><span class="n">allTasksByUser</span><span class="p">(</span><span class="n">user1</span><span class="p">).</span><span class="n">fix</span><span class="p">().</span><span class="n">observable</span><span class="p">.</span><span class="n">subscribe</span><span class="p">(</span><span class="o">::</span><span class="n">println</span><span class="p">,</span> <span class="o">::</span><span class="n">println</span><span class="p">)</span>
      <span class="n">repository</span><span class="p">.</span><span class="n">allTasksByUser</span><span class="p">(</span><span class="n">user2</span><span class="p">).</span><span class="n">fix</span><span class="p">().</span><span class="n">observable</span><span class="p">.</span><span class="n">subscribe</span><span class="p">(</span><span class="o">::</span><span class="n">println</span><span class="p">,</span> <span class="o">::</span><span class="n">println</span><span class="p">)</span>
      <span class="n">repository</span><span class="p">.</span><span class="n">allTasksByUser</span><span class="p">(</span><span class="n">user3</span><span class="p">).</span><span class="n">fix</span><span class="p">().</span><span class="n">observable</span><span class="p">.</span><span class="n">subscribe</span><span class="p">(</span><span class="o">::</span><span class="n">println</span><span class="p">,</span> <span class="o">::</span><span class="n">println</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="kd">val</span> <span class="py">flowableModule</span> <span class="p">=</span> <span class="n">Module</span><span class="p">(</span><span class="n">FlowableK</span><span class="p">.</span><span class="n">async</span><span class="p">())</span>
    <span class="n">flowableModule</span><span class="p">.</span><span class="n">run</span> <span class="p">{</span>
      <span class="n">repository</span><span class="p">.</span><span class="n">allTasksByUser</span><span class="p">(</span><span class="n">user1</span><span class="p">).</span><span class="n">fix</span><span class="p">().</span><span class="n">flowable</span><span class="p">.</span><span class="n">subscribe</span><span class="p">(</span><span class="o">::</span><span class="n">println</span><span class="p">)</span>
      <span class="n">repository</span><span class="p">.</span><span class="n">allTasksByUser</span><span class="p">(</span><span class="n">user2</span><span class="p">).</span><span class="n">fix</span><span class="p">().</span><span class="n">flowable</span><span class="p">.</span><span class="n">subscribe</span><span class="p">(</span><span class="o">::</span><span class="n">println</span><span class="p">)</span>
      <span class="n">repository</span><span class="p">.</span><span class="n">allTasksByUser</span><span class="p">(</span><span class="n">user3</span><span class="p">).</span><span class="n">fix</span><span class="p">().</span><span class="n">flowable</span><span class="p">.</span><span class="n">subscribe</span><span class="p">(</span><span class="o">::</span><span class="n">println</span><span class="p">,</span> <span class="o">::</span><span class="n">println</span><span class="p">)</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Printing:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[Task(value=LocalTask assigned to user1)]
[Task(value=Remote Task assigned to user2)]
UserNotInRemoteStorage(user=User(userId=UserId(value=unknown user)))

[Task(value=LocalTask assigned to user1)]
[Task(value=Remote Task assigned to user2)]
UserNotInRemoteStorage(user=User(userId=UserId(value=unknown user)))
</code></pre></div></div>

<p>Everything working as expected. 💪</p>

<p>Let&rsquo;s try the <a href="../../integrations/kotlinxcoroutines/index.html"><code class="highlighter-rouge">DeferredK</code></a> wrapper for the 
<code class="highlighter-rouge">kotlinx.coroutines.Deferred</code> type:</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">object</span> <span class="nc">test</span> <span class="p">{</span>

  <span class="nd">@JvmStatic</span>
  <span class="k">fun</span> <span class="nf">main</span><span class="p">(</span><span class="nv">args</span><span class="p">:</span> <span class="nc">Array</span><span class="p">&lt;</span><span class="nc">String</span><span class="p">&gt;):</span> <span class="nc">Unit</span> <span class="p">{</span>
    <span class="kd">val</span> <span class="py">user1</span> <span class="p">=</span> <span class="n">User</span><span class="p">(</span><span class="n">UserId</span><span class="p">(</span><span class="s">&#34;user1&#34;</span><span class="p">))</span>
    <span class="kd">val</span> <span class="py">user2</span> <span class="p">=</span> <span class="n">User</span><span class="p">(</span><span class="n">UserId</span><span class="p">(</span><span class="s">&#34;user2&#34;</span><span class="p">))</span>
    <span class="kd">val</span> <span class="py">user3</span> <span class="p">=</span> <span class="n">User</span><span class="p">(</span><span class="n">UserId</span><span class="p">(</span><span class="s">&#34;unknown user&#34;</span><span class="p">))</span>

    <span class="kd">val</span> <span class="py">deferredModule</span> <span class="p">=</span> <span class="n">Module</span><span class="p">(</span><span class="n">DeferredK</span><span class="p">.</span><span class="n">async</span><span class="p">())</span>
    <span class="n">deferredModule</span><span class="p">.</span><span class="n">run</span> <span class="p">{</span>
      <span class="n">runBlocking</span> <span class="p">{</span>
        <span class="k">try</span> <span class="p">{</span>
          <span class="n">println</span><span class="p">(</span><span class="n">repository</span><span class="p">.</span><span class="n">allTasksByUser</span><span class="p">(</span><span class="n">user1</span><span class="p">).</span><span class="n">fix</span><span class="p">().</span><span class="n">deferred</span><span class="p">.</span><span class="n">await</span><span class="p">())</span>
          <span class="n">println</span><span class="p">(</span><span class="n">repository</span><span class="p">.</span><span class="n">allTasksByUser</span><span class="p">(</span><span class="n">user2</span><span class="p">).</span><span class="n">fix</span><span class="p">().</span><span class="n">deferred</span><span class="p">.</span><span class="n">await</span><span class="p">())</span>
          <span class="n">println</span><span class="p">(</span><span class="n">repository</span><span class="p">.</span><span class="n">allTasksByUser</span><span class="p">(</span><span class="n">user3</span><span class="p">).</span><span class="n">fix</span><span class="p">().</span><span class="n">deferred</span><span class="p">.</span><span class="n">await</span><span class="p">())</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nv">e</span><span class="p">:</span> <span class="nc">UserNotInRemoteStorage</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">println</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>As you know, you&rsquo;re in charge to catch exceptions on coroutines. As you can see, implementation details as this catch, 
or the observable subscriptions from previous examples, are implementation details related to the given data types being 
used for each case, so those must live here, in the program&rsquo;s edge.</p>

<p>Same result one more time:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[Task(value=LocalTask assigned to user1)]
[Task(value=Remote Task assigned to user2)]
UserNotInRemoteStorage(user=User(userId=UserId(value=unknown user)))
</code></pre></div></div>

<p>There&rsquo;s also an alternative api provided by Arrow a bit more fancier for <a href="../../integrations/kotlinxcoroutines/index.html"><code class="highlighter-rouge">DeferredK</code></a>. It takes care of runBlocking and awaiting on the operations for you:</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">object</span> <span class="nc">test</span> <span class="p">{</span>

  <span class="nd">@JvmStatic</span>
  <span class="k">fun</span> <span class="nf">main</span><span class="p">(</span><span class="nv">args</span><span class="p">:</span> <span class="nc">Array</span><span class="p">&lt;</span><span class="nc">String</span><span class="p">&gt;):</span> <span class="nc">Unit</span> <span class="p">{</span>
    <span class="kd">val</span> <span class="py">user1</span> <span class="p">=</span> <span class="n">User</span><span class="p">(</span><span class="n">UserId</span><span class="p">(</span><span class="s">&#34;user1&#34;</span><span class="p">))</span>
    <span class="kd">val</span> <span class="py">user2</span> <span class="p">=</span> <span class="n">User</span><span class="p">(</span><span class="n">UserId</span><span class="p">(</span><span class="s">&#34;user2&#34;</span><span class="p">))</span>
    <span class="kd">val</span> <span class="py">user3</span> <span class="p">=</span> <span class="n">User</span><span class="p">(</span><span class="n">UserId</span><span class="p">(</span><span class="s">&#34;unknown user&#34;</span><span class="p">))</span>

    <span class="kd">val</span> <span class="py">deferredModuleAlt</span> <span class="p">=</span> <span class="n">Module</span><span class="p">(</span><span class="n">DeferredK</span><span class="p">.</span><span class="n">async</span><span class="p">())</span>
    <span class="n">deferredModuleAlt</span><span class="p">.</span><span class="n">run</span> <span class="p">{</span>
      <span class="n">println</span><span class="p">(</span><span class="n">repository</span><span class="p">.</span><span class="n">allTasksByUser</span><span class="p">(</span><span class="n">user1</span><span class="p">).</span><span class="n">fix</span><span class="p">().</span><span class="n">unsafeAttemptSync</span><span class="p">())</span>
      <span class="n">println</span><span class="p">(</span><span class="n">repository</span><span class="p">.</span><span class="n">allTasksByUser</span><span class="p">(</span><span class="n">user2</span><span class="p">).</span><span class="n">fix</span><span class="p">().</span><span class="n">unsafeAttemptSync</span><span class="p">())</span>
      <span class="n">println</span><span class="p">(</span><span class="n">repository</span><span class="p">.</span><span class="n">allTasksByUser</span><span class="p">(</span><span class="n">user3</span><span class="p">).</span><span class="n">fix</span><span class="p">().</span><span class="n">unsafeAttemptSync</span><span class="p">())</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>This one wraps the result into <a href="https://next.arrow-kt.io/docs/arrow/core/try"><code class="highlighter-rouge">Try</code></a> (which can be <code class="highlighter-rouge">Success</code> or <code class="highlighter-rouge">Failure</code>).</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Success(value=[Task(value=LocalTask assigned to user1)])
Success(value=[Task(value=Remote Task assigned to user2)])
Failure(exception=UserNotInRemoteStorage(user=User(userId=UserId(value=unknown user))))
</code></pre></div></div>

<p>Finally, let&rsquo;s use a more fancy data type related to Functional Programming: <a href="https://next.arrow-kt.io/docs/effects/io"><code class="highlighter-rouge">IO</code></a>. 
<code class="highlighter-rouge">IO</code> exists to wrap an in/out operation that causes side effects and make it pure.</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">object</span> <span class="nc">test</span> <span class="p">{</span>

  <span class="nd">@JvmStatic</span>
  <span class="k">fun</span> <span class="nf">main</span><span class="p">(</span><span class="nv">args</span><span class="p">:</span> <span class="nc">Array</span><span class="p">&lt;</span><span class="nc">String</span><span class="p">&gt;):</span> <span class="nc">Unit</span> <span class="p">{</span>
    <span class="kd">val</span> <span class="py">user1</span> <span class="p">=</span> <span class="n">User</span><span class="p">(</span><span class="n">UserId</span><span class="p">(</span><span class="s">&#34;user1&#34;</span><span class="p">))</span>
    <span class="kd">val</span> <span class="py">user2</span> <span class="p">=</span> <span class="n">User</span><span class="p">(</span><span class="n">UserId</span><span class="p">(</span><span class="s">&#34;user2&#34;</span><span class="p">))</span>
    <span class="kd">val</span> <span class="py">user3</span> <span class="p">=</span> <span class="n">User</span><span class="p">(</span><span class="n">UserId</span><span class="p">(</span><span class="s">&#34;unknown user&#34;</span><span class="p">))</span>

    <span class="kd">val</span> <span class="py">ioModule</span> <span class="p">=</span> <span class="n">Module</span><span class="p">(</span><span class="n">IO</span><span class="p">.</span><span class="n">async</span><span class="p">())</span>
    <span class="n">ioModule</span><span class="p">.</span><span class="n">run</span> <span class="p">{</span>
      <span class="n">println</span><span class="p">(</span><span class="n">repository</span><span class="p">.</span><span class="n">allTasksByUser</span><span class="p">(</span><span class="n">user1</span><span class="p">).</span><span class="n">fix</span><span class="p">().</span><span class="n">attempt</span><span class="p">().</span><span class="n">unsafeRunSync</span><span class="p">())</span>
      <span class="n">println</span><span class="p">(</span><span class="n">repository</span><span class="p">.</span><span class="n">allTasksByUser</span><span class="p">(</span><span class="n">user2</span><span class="p">).</span><span class="n">fix</span><span class="p">().</span><span class="n">attempt</span><span class="p">().</span><span class="n">unsafeRunSync</span><span class="p">())</span>
      <span class="n">println</span><span class="p">(</span><span class="n">repository</span><span class="p">.</span><span class="n">allTasksByUser</span><span class="p">(</span><span class="n">user3</span><span class="p">).</span><span class="n">fix</span><span class="p">().</span><span class="n">attempt</span><span class="p">().</span><span class="n">unsafeRunSync</span><span class="p">())</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Right(b=[Task(value=LocalTask assigned to user1)])
Right(b=[Task(value=Remote Task assigned to user2)])
Left(a=UserNotInRemoteStorage(user=User(userId=UserId(value=unknown user))))
</code></pre></div></div>

<p><a href="https://next.arrow-kt.io/docs/effects/io"><code class="highlighter-rouge">IO</code></a> is a bit special. It returns the errors / successful results using 
<a href="https://next.arrow-kt.io/docs/arrow/core/either"><code class="highlighter-rouge">Either&lt;L,R&gt;</code></a> (which is another data type). By convention, the &ldquo;left&rdquo; 
side of an either (<code class="highlighter-rouge">L</code>) stores the errors, and the right side (<code class="highlighter-rouge">R</code>) stores the successful data. That&rsquo;s why successful 
results are printed as <code class="highlighter-rouge">Right(...)</code> and the failing one is printed as <code class="highlighter-rouge">Left(...)</code>.</p>

<p>But the result is conceptually the same.</p>

<p>And with this, we are done with all the testing. As you can see we are able to run the same code stack using different 
data types, so our program has become complete agnostic of those.</p>

<p><a href="https://gist.github.com/JorgeCastilloPrz/c0a4604b9a5dedc89be82b13cfcc1315">Here you have the polymorphic app all together</a> 
for copy / paste purposes.</p>

<h3 id="this-is-cool-but-why-shouldi">This is cool but&hellip; why should&nbsp;I?</h3>

<p>That&rsquo;s always your choice, but there are some important benefits that FP brings to the table that you&rsquo;ll need to know 
when the time comes.</p>

<ul>
  <li>
    <p>You have a really clear separation of concerns: How the data is operated and composed (your actual program) vs the 
runtime. This means <strong>better testability</strong>.</p>
  </li>
  <li>
    <p>Your programs would ideally target abstractions so you have the choice on how to implement them depending on your 
needs / environments (i.e: testing). That&rsquo;s ultimately a DI related concept, so for sure you can do that without the 
need for FP. Said that, the FP approach leads you to program in such a way that is less prone to break this &ldquo;principle&rdquo;. 
That&rsquo;s because there&rsquo;s a clearly defined boundary between the declarative algebras (operations) and the runtime (types 
used to run it), where the details are.</p>
  </li>
  <li>
    <p>Composing your program algebras (operations) based on abstractions allows to keep your codebase deterministic and free 
of unexpected effects (pure). If you want to know more about purity and why pure code is less prone to errors or 
unexpected behaviours, <a href="https://medium.com/@JorgeCastilloPr/kotlin-functional-programming-does-it-make-sense-36ad07e6bacf">take a look at this post</a>.</p>
  </li>
  <li>
    <p>Following the previous point, your program side effects are controlled at the edge. Effects are caused by 
implementation details passed from a single point on the system. (Anything beyond the edge boundaries remains pure).</p>
  </li>
  <li>
    <p>If you chose to just work with <a href="https://next.arrow-kt.io/docs/typeclasses/intro">Typeclasses</a>, you&rsquo;ll get a unified 
API for all the data types. Repeatability helps to get familiarized with the concepts. (Repeatability as in just using 
operations like <code class="highlighter-rouge">map</code>, <code class="highlighter-rouge">flatMap</code>, <code class="highlighter-rouge">fold</code>, all the way, regardless of the problem you&rsquo;re solving. Of course that&rsquo;s 
constrained to using some libraries that enable pure FP over Kotlin and provide those operations and constructs, like 
Arrow.</p>
  </li>
  <li>
    <p>These patterns <strong>remove the need for specific DI frameworks</strong>, since they&rsquo;re based on the same concepts of Dependency 
Injection out of the box. You&rsquo;re always able to provide implementation details later on and switch them transparently, 
and before that moment your program is not tied to any &ldquo;side-effecty&rdquo; details. This approach could be considered DI by 
itself actually, since it&rsquo;s based on targeting abstractions leaving details to be passed form a single point in the 
edge.</p>
  </li>
  <li>
    <p>As a final conclusion, I&rsquo;d suggest you to use the approach that fits better your needs. Functional Programming is not 
going to solve all your problems, since there are not silver bullets, but it&rsquo;s a totally legit choice which brings a 
bunch of key benefits.</p>
  </li>
</ul>

<h3 id="related-links">Related links</h3>

<p>If you want to move further on <strong>typeclasses</strong>, you can <a href="https://next.arrow-kt.io/docs/typeclasses/intro">read the docs section about them</a>. 
Still I&rsquo;ll be happy if you got to understand that <strong>they&rsquo;re used as contracts to compose our polymorphic programs based 
on abstraction</strong> thanks to this post.</p>

<p>If you still have any doubts, please don&rsquo;t hesitate to contact me. The fastest way to do it is my Twitter handle: <a href="https://www.twitter.com/JorgeCastilloPR">@JorgeCastilloPR</a>.</p>

<p>Some of the mentioned concepts like purity are described in the following blogposts:</p>

<ul>
  <li><a href="https://medium.com/@JorgeCastilloPr/kotlin-functional-programming-does-it-make-sense-36ad07e6bacf">Kotlin Functional Programming: Does it make sense?</a> by <a href="https://www.twitter.com/JorgeCastilloPR">Jorge Castillo</a>)</li>
  <li><a href="https://medium.com/@JorgeCastilloPr/kotlin-purity-and-function-memoization-b12ab35d70a5">Kotlin purity and Function Memoization</a> by <a href="https://www.twitter.com/JorgeCastilloPR">Jorge Castillo</a>)</li>
</ul>

<p>Also, consider watching <a href="https://youtu.be/sxudIMiOo68">FP to the max</a> by <a href="https://twitter.com/jdegoes">John De Goes</a> and
the related <code class="highlighter-rouge">FpToTheMax.kt</code> example located in the <code class="highlighter-rouge">arrow-examples</code> module. This technique may seem to be a huge overhead
on such a small example, but it is meant to be used at scale.</p>

    </div>
</div>

</div>
<!-- Jquery -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<!-- Arrow playground -->
<script src="https://unpkg.com/arrow-playground@1" data-selector="[class^=&#39;language-kotlin&#39;]"></script>
<!-- Highlight -->
<script src="../../../js/highlight.pack.js"></script>
<script>
  hljs.initHighlighting();
</script>
<!-- Docsearch -->
<script type="text/javascript" src="../../../js/docsearch.min.js"></script>
<!-- Custom scripts for this template -->
<script src="../../../js/functions.js"></script>
<!-- Gitter -->
<script>
  ((window.gitter = {}).chat = {}).options = {
    room: 'arrow-kt/Lobby'
  };

</script>
<script src="https://sidecar.gitter.im/dist/sidecar.v1.js" async="" defer=""></script>



</body></html>